<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Produtividade Clínica</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script> 

    <style>
        body { background-color: #f8f9fa; }
        .dashboard-header { background-color: #007bff; color: white; padding: 20px 0; margin-bottom: 30px; }
        
        /* --- ESTILO KPI CARD --- */
        .kpi-card { 
            border-left: 5px solid #007bff; 
            border-radius: .5rem; 
            transition: transform 0.2s, box-shadow 0.2s;
            background-color: white; 
            box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,.05);
            min-height: 120px;
            display: flex; 
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .kpi-card:hover { transform: translateY(-3px); box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15); }
        
        .kpi-card h5 {
            word-wrap: break-word; 
            text-align: center;
            font-size: 0.9rem; 
            min-height: 40px; 
            margin-bottom: 0.25rem;
        }
        
        .kpi-card p { margin-top: 5px; }
        
        /* --- ESTILO GERAL --- */
        .chart-container { 
            background-color: white; 
            padding: 20px; 
            border-radius: .5rem; 
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15); 
            position: relative; 
        }
        .form-select, .form-control { border-radius: .3rem; }
        .alert-loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }
        #detailedTableContainer thead th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 10;
        }
    </style>
</head>
<body>

    <header class="dashboard-header">
        <div class="container">
            <h1 class="text-center">Painel de Indicadores de Produtividade Clínica</h1>
            <p class="text-center">Dados carregados do Banco de Dados</p>
            
            <div class="text-center mt-3">
                <a href="index.html" class="btn btn-sm btn-light">
                    &larr; Voltar à Página Inicial
                </a>
            </div>
        </div>
    </header>

    <main class="container">
        
        <div id="loadingMessage" class="alert alert-info alert-loading" role="alert" style="display:none;">
            <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div>
            Carregando dados do banco de dados...
        </div>
        
        <div id="filterAlert" class="alert alert-warning text-center" role="alert" style="display:none;">
            <strong>⚠️ Nenhum dado encontrado.</strong> Verifique os filtros de Data e Médico.
        </div>
        
        <section id="filters" class="mb-4 p-4 chart-container">
            <h4 class="mb-3">Filtros de Visualização</h4>
            <div class="row g-3 mb-3">
                <div class="col-md-6 col-lg-3">
                    <label for="filtroCliente" class="form-label fw-bold">1. Filtrar por Cliente:</label>
                    <select class="form-select" id="filtroCliente" disabled>
                        <option value="todos">Carregando...</option>
                    </select>
                </div>
                
                <div class="col-md-6 col-lg-3">
                    <label for="filtroUnidade" class="form-label fw-bold">2. Filtrar por Unidade:</label>
                    <select class="form-select" id="filtroUnidade" disabled>
                        <option value="todos">Carregando...</option>
                    </select>
                </div>

                <div class="col-md-12 col-lg-6">
                    <label for="filtroMedico" class="form-label fw-bold">3. Filtrar por Médico (Use Ctrl/Cmd para múltiplos):</label>
                    <select class="form-select" id="filtroMedico" multiple size="5" disabled>
                        <option value="todos">Carregando...</option>
                    </select>
                </div>
            </div>
            
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="filtroTurno" class="form-label fw-bold">4. Filtrar por Turno:</label>
                    <select class="form-select" id="filtroTurno" disabled>
                        <option value="todos">Carregando...</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="filtroData" class="form-label fw-bold">5. Filtrar por Data (A partir de):</label>
                    <input type="date" class="form-control" id="filtroData" disabled>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-md-6">
                    <button class="btn btn-primary w-100" id="applyFiltersBtn" disabled>Aplicar Filtros</button>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-secondary w-100" id="clearFiltersBtn" disabled>Limpar Filtros</button>
                </div>
            </div>
            <div class="row g-3 mt-3">
                <div class="col-md-12">
                    <label for="dbFileName" class="form-label fw-bold" id="data-source-label">FONTE DE DADOS:</label>
                    <input class="form-control" type="text" id="dbFileName" value="Coleção: produtividade" readonly style="color:#007bff;">
                </div>
            </div>
        </section>

        <section id="kpis" class="mb-5">
            <div class="row text-center">
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card kpi-card p-3 shadow-sm" style="border-left-color: #198754 !important;">
                        <h5 class="card-title text-muted">Novos Atendimentos</h5>
                        <p class="card-text fs-3 fw-bold text-success" id="totalAtendimentosMedico">0</p>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card kpi-card p-3 shadow-sm" style="border-left-color: #dc3545 !important;">
                        <h5 class="card-title text-muted">Total de Reavaliações</h5>
                        <p class="card-text fs-3 fw-bold text-danger" id="totalEV">0</p>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card kpi-card p-3 shadow-sm" style="border-left-color: #0d6efd !important;">
                        <h5 class="card-title text-muted">Atend. + Reavaliações</h5>
                        <p class="card-text fs-3 fw-bold text-primary" id="totalAtendimentos">0</p>
                    </div>
                </div>
            </div>

            <h5 class="mt-4 mb-3 text-muted">Novos Atendimentos por Turno</h5>
            <div class="row text-center">
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card kpi-card p-3 shadow-sm" style="border-left-color: #007bff !important;">
                        <h5 class="card-title text-muted">Novos Atend. - DIURNO</h5>
                        <p class="card-text fs-3 fw-bold text-primary" id="kpiDiurno">0</p>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card kpi-card p-3 shadow-sm" style="border-left-color: #ffc107 !important;">
                        <h5 class="card-title text-muted">Novos Atend. - INTERMEDIÁRIO</h5>
                        <p class="card-text fs-3 fw-bold text-warning" id="kpiIntermediario">0</p>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card kpi-card p-3 shadow-sm" style="border-left-color: #28a745 !important;">
                        <h5 class="card-title text-muted">Novos Atend. - NOTURNO</h5>
                        <p class="card-text fs-3 fw-bold text-success" id="kpiNoturno">0</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="charts">
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="chart-container" style="height: 400px;">
                        <h5 class="text-center mb-3">Produtividade por Médico (Atend. Totais)</h5>
                        <canvas id="produtividadePorMedicoChart"></canvas>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="chart-container" style="height: 400px;">
                        <h5 class="text-center mb-3">Atendimentos por Dia da Semana</h5>
                        <canvas id="atendimentosDiaSemanaChart"></canvas>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="chart-container" style="height: 400px;">
                        <h5 class="text-center mb-3">Exames Solicitados por Médico</h5>
                        <canvas id="examesPorMedicoChart"></canvas>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="chart-container" style="height: 400px;">
                        <h5 class="text-center mb-3">Medicações Prescritas por Médico</h5>
                        <canvas id="medicacoesPorMedicoChart"></canvas>
                    </div>
                </div>
                
                <div class="col-12 mb-4">
                    <div class="chart-container" style="height: 300px;">
                        <h5 class="text-center mb-3">Fichas de Classificação de Risco (Total Geral)</h5>
                        <canvas id="fichasClassificacaoChart"></canvas>
                    </div>
                </div>

                <div class="col-12 mb-4">
                    <div class="chart-container" style="height: 300px;">
                        <h5 class="text-center mb-3">Medicações Prescritas (Total Geral)</h5>
                        <canvas id="medicacoesChart"></canvas>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="detailed-data" class="mb-5">
            <div class="chart-container p-4">
                <h4 class="mb-3" id="detailed-data-title">Detalhes da Produtividade</h4>
                <div id="detailedTableContainer" style="overflow-x: auto; max-height: 500px; border: 1px solid #ddd; border-radius: .3rem;">
                    <p class="text-center text-muted p-4 mb-0">Selecione um médico ou aplique filtros para carregar os dados detalhados.</p>
                </div>
            </div>
        </section>
    </main>
    <footer class="text-center text-muted py-3">Dashboard de Produtividade</footer>

<script>
    // FIREBASE CONFIGURAÇÃO
    const firebaseConfig = {
        apiKey: "AIzaSyA_22plUsZfyzW909W1ePkCJxq-KdUydcw",
        authDomain: "produtividade-4d98e.firebaseapp.com",
        projectId: "produtividade-4d98e",
        storageBucket: "produtividade-4d98e.firebasestorage.app",
        messagingSenderId: "642824868640",
        appId: "1:642824868640:web:3e6ea0e09c41ec09023d45",
        measurementId: "G-489RSTNQVT"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const PRODUTIVIDADE_COLLECTION = 'produtividade'; 
    // FIM FIREBASE CONFIGURAÇÃO
    
    let allData = [];
    let examesPorMedicoChartInstance;
    let medicacoesPorMedicoChartInstance;
    let produtividadePorMedicoChartInstance;
    let atendimentosDiaSemanaChartInstance;
    let medicacoesChartInstance;
    let fichasClassificacaoChartInstance; 

    const colors = {
        primario: 'rgba(0, 123, 255, 0.7)', // Azul
        secundario: 'rgba(40, 167, 69, 0.7)', // Verde
        amarelo: 'rgba(255, 193, 7, 0.7)', // Amarelo
        vermelho: 'rgba(220, 53, 69, 0.7)', // Vermelho/Perigo
        roxo: 'rgba(108, 99, 255, 0.7)', 
        ciano: 'rgba(23, 162, 184, 0.7)',
        cinza: 'rgba(108, 117, 125, 0.7)', // Cinza/Secundário
        laranja: 'rgba(253, 126, 20, 0.7)' // Laranja
    };

    // --- DEFINIÇÃO DAS CHAVES INTERNAS ---
    const K_DATA = 'data';
    const K_MEDICO = 'medico'; 
    const K_ATEND_TOTAL = 'atend_total'; 
    const K_ATEND_NOVO = 'atend_novo'; 
    const K_REAVALIACOES = 'reavaliacoes'; 
    const K_TOTAL_GERAL = 'total_geral_completo';
    const K_ECHO = 'echo';
    const K_ELETRO = 'eletro';
    const K_LAB = 'lab';
    const K_RX = 'rx';
    const K_TOMO = 'tomo';
    const K_USG = 'usg';
    const K_MED_EV = 'med_ev';
    const K_MED_IM = 'med_im';
    const K_MED_SUBCUT = 'med_subcut';
    const K_MED_VO = 'med_vo';
    const K_MED_OFTAL = 'med_oftal';
    const K_MED_INAL = 'med_inal';
    const K_DIA_SEMANA = 'dia_semana';
    const K_TURNO = 'turno'; 
    const K_CLIENTE = 'cliente';
    const K_UNIDADE = 'unidade'; 
    const K_FICHA_VERDE = 'ficha_verde';
    const K_FICHA_AMARELA = 'ficha_amarela';
    const K_FICHA_LARANJA = 'ficha_laranja';
    const K_FICHA_AZUL = 'ficha_azul';
    const K_FICHA_BRANCA = 'ficha_branca';
    
    // --- CHAVES DE CORRESPONDÊNCIA (CORREÇÃO AQUI COM []) ---
    const COLUMN_MAP_KEYS = {
        [K_DATA]: "Data do plantão:  ",
        [K_TURNO]: "Diurno ou noturno:",
        [K_DIA_SEMANA]: "Dia da semana:",
        [K_MEDICO]: "Nome do médico ",
        [K_ATEND_NOVO]: "Número de Novos atendimentos:",
        [K_REAVALIACOES]: "Número Reavalições",
        [K_FICHA_BRANCA]: "Número de fichas brancas",
        [K_FICHA_AZUL]: "Número de fichas azul",
        [K_FICHA_VERDE]: "Número de fichas verdes",
        [K_FICHA_AMARELA]: "Número de fichas amarelas",
        [K_FICHA_LARANJA]: "Número de fichas laranja",
        [K_LAB]: "Número de laboratoriais",
        [K_RX]: "Número de RX",
        [K_TOMO]: "Tomografias",
        [K_USG]: "USG",
        [K_MED_EV]: "Medicação prescritas EV",
        [K_MED_IM]: "Medicação prescritas IM",
        [K_MED_SUBCUT]: "Medicação Subcultanea",
        [K_MED_VO]: "Medicação VO ou Subligual",
        [K_MED_INAL]: "INALATORIA",
        [K_MED_OFTAL]: "OFTALMICA"
    };

    // --- CHAVES E ORDEM PARA EXIBIÇÃO (CORREÇÃO AQUI COM []) ---
    const DISPLAY_COLUMNS = {
        [K_DATA]: 'Data',
        [K_CLIENTE]: 'Cliente', 
        [K_UNIDADE]: 'Unidade', 
        [K_MEDICO]: 'Médico',
        [K_TURNO]: 'Turno', 
        [K_ATEND_NOVO]: 'Novos Atend.',
        [K_REAVALIACOES]: 'Reavaliações',
        [K_TOTAL_GERAL]: 'Total Geral (N+R)',
        [K_ATEND_TOTAL]: 'Atend. Total (Orig.)',
        [K_DIA_SEMANA]: 'Dia da Semana',
        [K_ECHO]: 'Echo',
        [K_ELETRO]: 'Eletro',
        [K_LAB]: 'Lab',
        [K_RX]: 'RX',
        [K_TOMO]: 'Tomo',
        [K_USG]: 'USG',
        [K_MED_EV]: 'Med. EV',
        [K_MED_IM]: 'Med. IM',
        [K_MED_SUBCUT]: 'Med. Subcut',
        [K_MED_VO]: 'Med. VO',
        [K_MED_OFTAL]: 'Med. Oftál',
        [K_MED_INAL]: 'Med. Inal',
        [K_FICHA_VERDE]: 'Ficha V.',
        [K_FICHA_AMARELA]: 'Ficha A.',
        [K_FICHA_LARANJA]: 'Ficha L.',
        [K_FICHA_AZUL]: 'Ficha Az.',
        [K_FICHA_BRANCA]: 'Ficha B.'
    };

    const COLUMN_ORDER = [
        K_DATA, K_CLIENTE, K_UNIDADE, K_MEDICO, K_TURNO, K_DIA_SEMANA, 
        K_ATEND_NOVO, K_REAVALIACOES, K_TOTAL_GERAL, K_ATEND_TOTAL, 
        K_FICHA_VERDE, K_FICHA_AMARELA, K_FICHA_LARANJA, K_FICHA_AZUL, K_FICHA_BRANCA,
        K_ECHO, K_ELETRO, K_LAB, K_RX, K_TOMO, K_USG, 
        K_MED_EV, K_MED_IM, K_MED_SUBCUT, K_MED_VO, K_MED_OFTAL, K_MED_INAL
    ];
	/**
     * @description Carrega os dados do Firebase Firestore e inicializa o dashboard.
     */
    async function initDashboard() {
        const loadingMessage = document.getElementById('loadingMessage');
        if (loadingMessage) loadingMessage.style.display = 'block';

        try {
            console.log("Tentando acessar a coleção:", PRODUTIVIDADE_COLLECTION);
            const snapshot = await db.collection(PRODUTIVIDADE_COLLECTION).get();
            
            if (snapshot.empty) {
                console.error("ERRO: Coleção vazia ou nome incorreto.");
                const sourceLabel = document.getElementById('data-source-label');
                if(sourceLabel) sourceLabel.innerHTML = `AVISO: <span style="color:orange;">Coleção '${PRODUTIVIDADE_COLLECTION}' não encontrada.</span>`;
                return;
            }

            const firstDoc = snapshot.docs[0].data();
            console.log("Campos reais no Firebase:", Object.keys(firstDoc));

            allData = snapshot.docs.map(doc => {
                const data = doc.data();
                const newRow = {};
                
                const smartGet = (possibleNames, isNumber = false) => {
                    const names = Array.isArray(possibleNames) ? possibleNames : [possibleNames];
                    let value = undefined;

                    for (let name of names) {
                        if (data[name] !== undefined) {
                            value = data[name];
                            break;
                        }
                    }

                    if (isNumber) {
                        return (Number(value) || 0);
                    }
                    return (value !== undefined && value !== null) ? String(value).trim() : '';
                };

                // --- MAPEAMENTO DOS CAMPOS CONFORME SEU ORIGINAL ---
                let rawDate = smartGet(["Data do plantão:  ", "Data do plantão:", "Data do plantao:", "Data"]);
                if (rawDate && typeof rawDate.toDate === 'function') {
                    newRow[K_DATA] = rawDate.toDate().toISOString().substring(0, 10);
                } else if (typeof rawDate === 'string' && rawDate.includes('/')) {
                    const parts = rawDate.split('/');
                    newRow[K_DATA] = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                } else {
                    newRow[K_DATA] = rawDate;
                }

                newRow[K_MEDICO] = smartGet(["Nome do médico ", "Nome do médico", "Nome do medico", "Nome do medico "]);
                newRow[K_TURNO] = smartGet(["Diurno ou noturno:", "Diurno ou noturno", "Turno", "TURNO"]);
                newRow[K_DIA_SEMANA] = smartGet(["Dia da semana:", "Dia da semana", "DIA DA SEMANA"]);
                newRow[K_CLIENTE] = smartGet(["Cliente", "CLIENTE", "Empresa"]);
                newRow[K_UNIDADE] = smartGet(["Unidade", "UNIDADE", "Local"]);

                newRow[K_ATEND_NOVO] = smartGet(["Número de Novos atendimentos:", "Numero de Novos atendimentos:", "Novos atendimentos"], true);
                newRow[K_REAVALIACOES] = smartGet(["Número Reavalições", "Numero Reavalicões", "Reavaliacoes"], true);
                newRow[K_TOTAL_GERAL] = newRow[K_ATEND_NOVO] + newRow[K_REAVALIACOES];
                newRow[K_ATEND_TOTAL] = smartGet(["Atendimento Total", "Total de atendimentos"], true);

                newRow[K_FICHA_VERDE] = smartGet(["Número de fichas verdes", "Numero de fichas verdes"], true);
                newRow[K_FICHA_AMARELA] = smartGet(["Número de fichas amarelas", "Numero de fichas amarelas"], true);
                newRow[K_FICHA_LARANJA] = smartGet(["Número de fichas laranja", "Numero de fichas laranja"], true);
                newRow[K_FICHA_AZUL] = smartGet(["Número de fichas azul", "Numero de fichas azul"], true);
                newRow[K_FICHA_BRANCA] = smartGet(["Número de fichas brancas", "Numero de fichas brancas"], true);

                newRow[K_ECHO] = smartGet(["Número de ecocardiograma", "Ecocardiograma"], true);
                newRow[K_ELETRO] = smartGet(["Número de eletrocardiograma", "Eletrocardiograma"], true);
                newRow[K_LAB] = smartGet(["Número de laboratoriais", "Numero de laboratoriais", "Laboratoriais"], true);
                newRow[K_RX] = smartGet(["Número de RX", "Numero de RX", "RX"], true);
                newRow[K_TOMO] = smartGet(["Tomografias", "TOMO", "Tomografia"], true);
                newRow[K_USG] = smartGet(["USG", "Ultrassonografia"], true);

                newRow[K_MED_EV] = smartGet(["Medicação prescritas EV", "Medicacao prescritas EV", "EV"], true);
                newRow[K_MED_IM] = smartGet(["Medicação prescritas IM", "Medicacao prescritas IM", "IM"], true);
                newRow[K_MED_SUBCUT] = smartGet(["Medicação Subcultanea", "Medicacao Subcultanea"], true);
                newRow[K_MED_VO] = smartGet(["Medicação VO ou Subligual", "Medicacao VO ou Subligual", "VO"], true);
                newRow[K_MED_INAL] = smartGet(["INALATORIA", "Inalatoria"], true);
                newRow[K_MED_OFTAL] = smartGet(["OFTALMICA", "Oftalmica"], true);
                
                return newRow;
            }).filter(row => row[K_MEDICO] !== '');

            console.log("Total de registros processados:", allData.length);

            if (allData.length > 0) {
                populateMedicoFilter(allData);
                populateTurnoFilter(allData);
                populateClienteFilter(allData);
                populateUnidadeFilter(allData);
                updateDashboard();

                const applyBtn = document.getElementById('applyFiltersBtn');
                const clearBtn = document.getElementById('clearFiltersBtn');
                if(applyBtn) applyBtn.onclick = updateDashboard;
                if(clearBtn) clearBtn.onclick = clearFilters;
                
                const controls = ['applyFiltersBtn', 'clearFiltersBtn', 'filtroData', 'filtroTurno', 'filtroMedico'];
                controls.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.disabled = false;
                });
                
                const sourceLabel = document.getElementById('data-source-label');
                if(sourceLabel) sourceLabel.innerHTML = `<span class="badge bg-success">Firebase: ${allData.length} registros carregados</span>`;
            }

        } catch (error) {
            console.error("Erro Crítico ao Inicializar:", error);
            const sourceLabel = document.getElementById('data-source-label');
            if(sourceLabel) sourceLabel.innerHTML = `<span style="color:red;">Erro de conexão com o Banco de Dados.</span>`;
        } finally {
            if (loadingMessage) loadingMessage.style.display = 'none';
        }
    }

    // --- FUNÇÕES DE POPULAÇÃO DOS FILTROS ---
    function populateClienteFilter(data) { 
        const clientesValidos = data.map(item => item[K_CLIENTE] ? String(item[K_CLIENTE]).trim().toUpperCase() : null).filter(c => c);
        const clientes = [...new Set(clientesValidos)].sort();
        const select = document.getElementById('filtroCliente');
        if(!select) return;
        select.innerHTML = '<option value="todos">Todos os Clientes</option>';
        clientes.forEach(c => {
            const option = document.createElement('option');
            option.value = c; option.textContent = c;
            select.appendChild(option);
        });
    }

    function populateUnidadeFilter(data) { 
        const unidadesValidas = data.map(item => item[K_UNIDADE] ? String(item[K_UNIDADE]).trim().toUpperCase() : null).filter(u => u);
        const unidades = [...new Set(unidadesValidas)].sort();
        const select = document.getElementById('filtroUnidade');
        if(!select) return;
        select.innerHTML = '<option value="todos">Todas as Unidades</option>';
        unidades.forEach(u => {
            const option = document.createElement('option');
            option.value = u; option.textContent = u;
            select.appendChild(option);
        });
    }

    function populateMedicoFilter(data) {
        const nomesValidos = data.map(item => item[K_MEDICO] ? String(item[K_MEDICO]).trim().toUpperCase() : null).filter(n => n);
        const medicos = [...new Set(nomesValidos)].sort();
        const select = document.getElementById('filtroMedico');
        if(!select) return;
        select.innerHTML = '';
        medicos.forEach(m => {
            const option = document.createElement('option');
            option.value = m; option.textContent = m;
            select.appendChild(option);
        });
    }

    function populateTurnoFilter(data) {
        const turnosValidos = data.map(item => item[K_TURNO] ? String(item[K_TURNO]).trim().toUpperCase() : null).filter(t => t);
        const turnos = [...new Set(turnosValidos)].sort();
        const select = document.getElementById('filtroTurno');
        if(!select) return;
        select.innerHTML = '<option value="todos">Todos os Turnos</option>';
        turnos.forEach(t => {
            const option = document.createElement('option');
            option.value = t; option.textContent = t;
            select.appendChild(option);
        });
    }

    // --- LÓGICA DE FILTRAGEM ---
    function filterData(data) {
        const selectMedicoElement = document.getElementById('filtroMedico');
        const selectedMedicos = selectMedicoElement ? Array.from(selectMedicoElement.selectedOptions).map(o => o.value.toUpperCase()) : [];
        const filtroData = document.getElementById('filtroData') ? document.getElementById('filtroData').value : '';
        const filtroTurno = document.getElementById('filtroTurno') ? document.getElementById('filtroTurno').value : 'todos'; 
        const filtroCliente = document.getElementById('filtroCliente') ? document.getElementById('filtroCliente').value : 'todos'; 
        const filtroUnidade = document.getElementById('filtroUnidade') ? document.getElementById('filtroUnidade').value : 'todos';
        
        let filteredData = data.filter(row => {
            const medicoNome = row[K_MEDICO] ? String(row[K_MEDICO]).trim().toUpperCase() : '';
            if (selectedMedicos.length === 0) return true;
            return selectedMedicos.includes(medicoNome);
        });

        filteredData = filteredData.filter(row => {
            const clienteNome = row[K_CLIENTE] ? String(row[K_CLIENTE]).trim().toUpperCase() : '';
            return filtroCliente === 'todos' || clienteNome === filtroCliente.toUpperCase();
        });

        filteredData = filteredData.filter(row => {
            const unidadeNome = row[K_UNIDADE] ? String(row[K_UNIDADE]).trim().toUpperCase() : '';
            return filtroUnidade === 'todos' || unidadeNome === filtroUnidade.toUpperCase();
        });

        filteredData = filteredData.filter(row => {
            const turnoNome = row[K_TURNO] ? String(row[K_TURNO]).trim().toUpperCase() : '';
            return filtroTurno === 'todos' || turnoNome === filtroTurno.toUpperCase();
        });

        if (filtroData) {
            filteredData = filteredData.filter(row => {
                const rowDate = String(row[K_DATA] || '').substring(0, 10);
                return rowDate >= filtroData;
            });
        }

        return filteredData;
    }

// --- GERAÇÃO DE KPIS E GRÁFICOS ---
    function generateKPIs(data) {
        // Função auxiliar para evitar erro caso o elemento ID não exista no HTML
        const safeSetText = (id, value) => {
            const el = document.getElementById(id);
            if (el) el.textContent = value.toLocaleString('pt-BR');
        };

        const totalAtendimentosOriginal = data.reduce((sum, row) => sum + (row[K_ATEND_TOTAL] || 0), 0);
        safeSetText('totalAtendimentos', totalAtendimentosOriginal);
        
        const novosAtendimentos = data.reduce((sum, row) => sum + (row[K_ATEND_NOVO] || 0), 0);
        safeSetText('totalAtendimentosMedico', novosAtendimentos);
        
        const totalReavaliacoes = data.reduce((sum, row) => sum + (row[K_REAVALIACOES] || 0), 0);
        safeSetText('totalEV', totalReavaliacoes);
        
        const totalGeralCompleto = data.reduce((sum, row) => sum + (row[K_TOTAL_GERAL] || 0), 0);
        safeSetText('totalEcocardiogramas', totalGeralCompleto);
        
        const turnos = data.reduce((acc, row) => {
            const t = String(row[K_TURNO] || '').trim().toUpperCase();
            if (t === 'DIURNO') acc.d += (row[K_ATEND_NOVO] || 0);
            else if (t === 'INTERMEDIARIO') acc.i += (row[K_ATEND_NOVO] || 0);
            else if (t === 'NOTURNO') acc.n += (row[K_ATEND_NOVO] || 0);
            return acc;
        }, { d: 0, i: 0, n: 0 });
        
        safeSetText('kpiDiurno', turnos.d);
        safeSetText('kpiIntermediario', turnos.i);
        safeSetText('kpiNoturno', turnos.n);
    }

    function createCharts(data) {
        // Destruir instâncias existentes se houver
        if (examesPorMedicoChartInstance) examesPorMedicoChartInstance.destroy();
        if (medicacoesPorMedicoChartInstance) medicacoesPorMedicoChartInstance.destroy();
        if (produtividadePorMedicoChartInstance) produtividadePorMedicoChartInstance.destroy();
        if (atendimentosDiaSemanaChartInstance) atendimentosDiaSemanaChartInstance.destroy();
        if (medicacoesChartInstance) medicacoesChartInstance.destroy();
        if (fichasClassificacaoChartInstance) fichasClassificacaoChartInstance.destroy();

        if (data.length === 0) return;

        // 1. Produtividade por Médico
        const prodData = data.reduce((acc, row) => {
            const m = String(row[K_MEDICO]).trim();
            acc[m] = (acc[m] || 0) + (row[K_ATEND_TOTAL] || 0);
            return acc;
        }, {});
        const prodSorted = Object.entries(prodData).sort((a,b) => b[1] - a[1]);

        const ctxProd = document.getElementById('produtividadePorMedicoChart');
        if (ctxProd) {
            produtividadePorMedicoChartInstance = new Chart(ctxProd, {
                type: 'bar',
                data: {
                    labels: prodSorted.map(x => x[0]),
                    datasets: [{ label: 'Atendimentos', data: prodSorted.map(x => x[1]), backgroundColor: colors.primario }]
                },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' }
            });
        }

        // 2. Dia da Semana
        const diasOrdem = ['SEGUNDA-FEIRA', 'TERÇA-FEIRA', 'QUARTA-FEIRA', 'QUINTA-FEIRA', 'SEXTA-FEIRA', 'SÁBADO', 'DOMINGO'];
        const diasData = data.reduce((acc, row) => {
            const d = String(row[K_DIA_SEMANA] || '').toUpperCase().trim();
            acc[d] = (acc[d] || 0) + (row[K_ATEND_TOTAL] || 0);
            return acc;
        }, {});
        const diasLabels = diasOrdem.filter(d => diasData[d] !== undefined);

        const ctxDia = document.getElementById('atendimentosDiaSemanaChart');
        if (ctxDia) {
            atendimentosDiaSemanaChartInstance = new Chart(ctxDia, {
                type: 'bar',
                data: {
                    labels: diasLabels,
                    datasets: [{ label: 'Total', data: diasLabels.map(d => diasData[d]), backgroundColor: colors.secundario }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // 3. Exames por Médico (Stacked)
        const medicosExames = [...new Set(data.map(r => String(r[K_MEDICO]).trim()))].sort();
        const datasetsExames = [
            { label: 'Lab', key: K_LAB, color: colors.primario },
            { label: 'RX', key: K_RX, color: colors.secundario },
            { label: 'Tomo', key: K_TOMO, color: colors.amarelo },
            { label: 'USG', key: K_USG, color: colors.vermelho }
        ].map(config => ({
            label: config.label,
            backgroundColor: config.color,
            data: medicosExames.map(m => data.filter(r => String(r[K_MEDICO]).trim() === m).reduce((s, r) => s + (r[config.key] || 0), 0))
        }));

        const ctxExames = document.getElementById('examesPorMedicoChart');
        if (ctxExames) {
            examesPorMedicoChartInstance = new Chart(ctxExames, {
                type: 'bar',
                data: { labels: medicosExames, datasets: datasetsExames },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } } }
            });
        }

        // 4. Medicações por Médico
        const medCols = [K_MED_EV, K_MED_IM, K_MED_SUBCUT, K_MED_VO, K_MED_OFTAL, K_MED_INAL];
        const medPorMed = data.reduce((acc, row) => {
            const m = String(row[K_MEDICO]).trim();
            const total = medCols.reduce((s, col) => s + (row[col] || 0), 0);
            acc[m] = (acc[m] || 0) + total;
            return acc;
        }, {});
        const medSorted = Object.entries(medPorMed).sort((a,b) => b[1] - a[1]);

        const ctxMedP = document.getElementById('medicacoesPorMedicoChart');
        if (ctxMedP) {
            medicacoesPorMedicoChartInstance = new Chart(ctxMedP, {
                type: 'bar',
                data: {
                    labels: medSorted.map(x => x[0]),
                    datasets: [{ label: 'Prescrições', data: medSorted.map(x => x[1]), backgroundColor: colors.vermelho }]
                },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' }
            });
        }

        // 5. Fichas por Classificação
        const fichasCols = [K_FICHA_VERDE, K_FICHA_AMARELA, K_FICHA_LARANJA, K_FICHA_AZUL, K_FICHA_BRANCA];
        const fichasLabels = ['Verde', 'Amarela', 'Laranja', 'Azul', 'Branca'];
        const fichasValues = fichasCols.map(col => data.reduce((s, r) => s + (r[col] || 0), 0));

        const ctxFichas = document.getElementById('fichasClassificacaoChart');
        if (ctxFichas) {
            fichasClassificacaoChartInstance = new Chart(ctxFichas, {
                type: 'bar',
                data: {
                    labels: fichasLabels,
                    datasets: [{ 
                        data: fichasValues, 
                        backgroundColor: [colors.secundario, colors.amarelo, colors.laranja, colors.primario, colors.cinza] 
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } } }
            });
        }

        // 6. Volume por Tipo de Medicação
        const medLabels = ['EV', 'IM', 'Subcut', 'VO', 'Oftal', 'Inal'];
        const medValues = medCols.map(col => data.reduce((s, r) => s + (r[col] || 0), 0));

        const ctxMedV = document.getElementById('medicacoesChart');
        if (ctxMedV) {
            medicacoesChartInstance = new Chart(ctxMedV, {
                type: 'bar',
                data: {
                    labels: medLabels,
                    datasets: [{ label: 'Total Geral', data: medValues, backgroundColor: colors.amarelo }]
                },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' }
            });
        }
    }

    // --- RENDERIZAÇÃO DA TABELA ---
    function renderDetailedTable(data) {
        const container = document.getElementById('detailedTableContainer');
        if (!container) return;
        
        if (data.length === 0) {
            container.innerHTML = '<p class="text-center p-4">Nenhum registro encontrado para os filtros selecionados.</p>';
            return;
        }

        const nonNumericCols = [K_DATA, K_MEDICO, K_TURNO, K_DIA_SEMANA, K_CLIENTE, K_UNIDADE];

        let tableHTML = `<table class="table table-striped table-hover table-sm"><thead><tr>`;
        COLUMN_ORDER.forEach(key => {
            tableHTML += `<th class="text-nowrap">${DISPLAY_COLUMNS[key] || key}</th>`;
        });
        tableHTML += `</tr></thead><tbody>`;

        data.forEach(row => {
            tableHTML += `<tr>`;
            COLUMN_ORDER.forEach(key => {
                let value = row[key];
                let alignment = 'text-center';

                if (typeof value === 'number') {
                    value = value.toLocaleString('pt-BR');
                } else if (key === K_DATA && value) {
                    const dp = String(value).substring(0, 10).split('-');
                    if (dp.length === 3) value = `${dp[2]}/${dp[1]}/${dp[0]}`;
                } else if (nonNumericCols.includes(key)) {
                    alignment = 'text-start'; 
                }
                
                tableHTML += `<td class="${alignment} text-nowrap">${value || '-'}</td>`;
            });
            tableHTML += `</tr>`;
        });
        tableHTML += `</tbody></table>`;
        container.innerHTML = tableHTML;
    }

    // --- FUNÇÕES AUXILIARES ---
    function toggleFilterAlert(show) {
        const alert = document.getElementById('filterAlert');
        if(alert) alert.style.display = show ? 'block' : 'none';
    }

    function clearFilters() {
        if(document.getElementById('filtroData')) document.getElementById('filtroData').value = '';
        if(document.getElementById('filtroTurno')) document.getElementById('filtroTurno').value = 'todos';
        if(document.getElementById('filtroCliente')) document.getElementById('filtroCliente').value = 'todos';
        if(document.getElementById('filtroUnidade')) document.getElementById('filtroUnidade').value = 'todos';
        
        const medSelect = document.getElementById('filtroMedico');
        if(medSelect) Array.from(medSelect.options).forEach(o => o.selected = false);
        
        updateDashboard();
    }

    function updateDashboard() {
        const filteredData = filterData(allData);

        if (filteredData.length === 0) {
            toggleFilterAlert(true);
            generateKPIs([]); 
            createCharts([]);
            renderDetailedTable([]); 
        } else {
            toggleFilterAlert(false);
            generateKPIs(filteredData);
            createCharts(filteredData);
            renderDetailedTable(filteredData); 
        }
    }

    // Início automático após carregar tudo
    initDashboard();	
	
	</script>
	
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>