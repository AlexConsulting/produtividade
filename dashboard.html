<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Produtividade Clínica</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script> 

    <style>
        body { background-color: #f8f9fa; }
        .dashboard-header { background-color: #007bff; color: white; padding: 20px 0; margin-bottom: 30px; }
        
        /* --- ESTILO KPI CARD --- */
        .kpi-card { 
            border-left: 5px solid #007bff; 
            border-radius: .5rem; 
            transition: transform 0.2s, box-shadow 0.2s;
            background-color: white; 
            box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,.05);
            min-height: 120px;
            display: flex; 
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .kpi-card:hover { transform: translateY(-3px); box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15); }
        
        .kpi-card h5 {
            word-wrap: break-word; 
            text-align: center;
            font-size: 0.9rem; 
            min-height: 40px; 
            margin-bottom: 0.25rem;
        }
        
        .kpi-card p { margin-top: 5px; }
        
        /* --- ESTILO GERAL --- */
        .chart-container { 
            background-color: white; 
            padding: 20px; 
            border-radius: .5rem; 
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15); 
            position: relative; 
        }
        .form-select, .form-control { border-radius: .3rem; }
        .alert-loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }
        #detailedTableContainer thead th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 10;
        }
    </style>
</head>
<body>

    <header class="dashboard-header">
        <div class="container">
            <h1 class="text-center">Painel de Indicadores de Produtividade Clínica</h1>
            <p class="text-center">Dados carregados do Banco de Dados</p>
            
            <div class="text-center mt-3">
                <a href="index.html" class="btn btn-sm btn-light">
                    &larr; Voltar à Página Inicial
                </a>
            </div>
        </div>
    </header>

    <main class="container">
        
        <div id="loadingMessage" class="alert alert-info alert-loading" role="alert" style="display:none;">
            <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div>
            Carregando dados do banco de dados...
        </div>
        
        <div id="filterAlert" class="alert alert-warning text-center" role="alert" style="display:none;">
            <strong>⚠️ Nenhum dado encontrado.</strong> Verifique os filtros de Data e Médico.
        </div>
        
        <section id="filters" class="mb-4 p-4 chart-container">
            <h4 class="mb-3">Filtros de Visualização</h4>
            <div class="row g-3 mb-3">
                <div class="col-md-6 col-lg-3">
                    <label for="filtroCliente" class="form-label fw-bold">1. Filtrar por Cliente:</label>
                    <select class="form-select" id="filtroCliente" disabled>
                        <option value="todos">Carregando...</option>
                    </select>
                </div>
                
                <div class="col-md-6 col-lg-3">
                    <label for="filtroUnidade" class="form-label fw-bold">2. Filtrar por Unidade:</label>
                    <select class="form-select" id="filtroUnidade" disabled>
                        <option value="todos">Carregando...</option>
                    </select>
                </div>

                <div class="col-md-12 col-lg-6">
                    <label for="filtroMedico" class="form-label fw-bold">3. Filtrar por Médico (Use Ctrl/Cmd para múltiplos):</label>
                    <select class="form-select" id="filtroMedico" multiple size="5" disabled>
                        <option value="todos">Carregando...</option>
                    </select>
                </div>
            </div>
            
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="filtroTurno" class="form-label fw-bold">4. Filtrar por Turno:</label>
                    <select class="form-select" id="filtroTurno" disabled>
                        <option value="todos">Carregando...</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="filtroData" class="form-label fw-bold">5. Filtrar por Data (A partir de):</label>
                    <input type="date" class="form-control" id="filtroData" disabled>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-md-6">
                    <button class="btn btn-primary w-100" id="applyFiltersBtn" disabled>Aplicar Filtros</button>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-secondary w-100" id="clearFiltersBtn" disabled>Limpar Filtros</button>
                </div>
            </div>
            <div class="row g-3 mt-3">
                <div class="col-md-12">
                    <label for="dbFileName" class="form-label fw-bold" id="data-source-label">FONTE DE DADOS:</label>
                    <input class="form-control" type="text" id="dbFileName" value="Coleção: produtividade" readonly style="color:#007bff;">
                </div>
            </div>
        </section>

        <section id="kpis" class="mb-5">
            <div class="row text-center">
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card kpi-card p-3 shadow-sm" style="border-left-color: #198754 !important;">
                        <h5 class="card-title text-muted">Novos Atendimentos</h5>
                        <p class="card-text fs-3 fw-bold text-success" id="totalAtendimentosMedico">0</p>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card kpi-card p-3 shadow-sm" style="border-left-color: #dc3545 !important;">
                        <h5 class="card-title text-muted">Total de Reavaliações</h5>
                        <p class="card-text fs-3 fw-bold text-danger" id="totalEV">0</p>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card kpi-card p-3 shadow-sm" style="border-left-color: #0d6efd !important;">
                        <h5 class="card-title text-muted">Atend. + Reavaliações</h5>
                        <p class="card-text fs-3 fw-bold text-primary" id="totalAtendimentos">0</p>
                    </div>
                </div>
            </div>

            <h5 class="mt-4 mb-3 text-muted">Novos Atendimentos por Turno</h5>
            <div class="row text-center">
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card kpi-card p-3 shadow-sm" style="border-left-color: #007bff !important;">
                        <h5 class="card-title text-muted">Novos Atend. - DIURNO</h5>
                        <p class="card-text fs-3 fw-bold text-primary" id="kpiDiurno">0</p>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card kpi-card p-3 shadow-sm" style="border-left-color: #ffc107 !important;">
                        <h5 class="card-title text-muted">Novos Atend. - INTERMEDIÁRIO</h5>
                        <p class="card-text fs-3 fw-bold text-warning" id="kpiIntermediario">0</p>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card kpi-card p-3 shadow-sm" style="border-left-color: #28a745 !important;">
                        <h5 class="card-title text-muted">Novos Atend. - NOTURNO</h5>
                        <p class="card-text fs-3 fw-bold text-success" id="kpiNoturno">0</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="charts">
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="chart-container" style="height: 400px;">
                        <h5 class="text-center mb-3">Produtividade por Médico (Atend. Totais)</h5>
                        <canvas id="produtividadePorMedicoChart"></canvas>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="chart-container" style="height: 400px;">
                        <h5 class="text-center mb-3">Atendimentos por Dia da Semana</h5>
                        <canvas id="atendimentosDiaSemanaChart"></canvas>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="chart-container" style="height: 400px;">
                        <h5 class="text-center mb-3">Exames Solicitados por Médico</h5>
                        <canvas id="examesPorMedicoChart"></canvas>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="chart-container" style="height: 400px;">
                        <h5 class="text-center mb-3">Medicações Prescritas por Médico</h5>
                        <canvas id="medicacoesPorMedicoChart"></canvas>
                    </div>
                </div>
                
                <div class="col-12 mb-4">
                    <div class="chart-container" style="height: 300px;">
                        <h5 class="text-center mb-3">Fichas de Classificação de Risco (Total Geral)</h5>
                        <canvas id="fichasClassificacaoChart"></canvas>
                    </div>
                </div>

                <div class="col-12 mb-4">
                    <div class="chart-container" style="height: 300px;">
                        <h5 class="text-center mb-3">Medicações Prescritas (Total Geral)</h5>
                        <canvas id="medicacoesChart"></canvas>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="detailed-data" class="mb-5">
            <div class="chart-container p-4">
                <h4 class="mb-3" id="detailed-data-title">Detalhes da Produtividade</h4>
                <div id="detailedTableContainer" style="overflow-x: auto; max-height: 500px; border: 1px solid #ddd; border-radius: .3rem;">
                    <p class="text-center text-muted p-4 mb-0">Selecione um médico ou aplique filtros para carregar os dados detalhados.</p>
                </div>
            </div>
        </section>
    </main>
    <footer class="text-center text-muted py-3">Dashboard de Produtividade</footer>

<script>
        // FIREBASE CONFIGURAÇÃO
        const firebaseConfig = {
            apiKey: "AIzaSyA_22plUsZfyzW909W1ePkCJxq-KdUydcw",
            authDomain: "produtividade-4d98e.firebaseapp.com",
            projectId: "produtividade-4d98e",
            storageBucket: "produtividade-4d98e.firebasestorage.app",
            messagingSenderId: "642824868640",
            appId: "1:642824868640:web:3e6ea0e09c41ec09023d45",
            measurementId: "G-489RSTNQVT"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const PRODUTIVIDADE_COLLECTION = 'produtividade'; 
        
        let allData = [];
        let examesPorMedicoChartInstance;
        let medicacoesPorMedicoChartInstance;
        let produtividadePorMedicoChartInstance;
        let atendimentosDiaSemanaChartInstance;
        let medicacoesChartInstance;
        let fichasClassificacaoChartInstance; 

        const colors = {
            primario: 'rgba(0, 123, 255, 0.7)', 
            secundario: 'rgba(108, 117, 125, 0.7)',
            sucesso: 'rgba(40, 167, 69, 0.7)',
            perigo: 'rgba(220, 53, 69, 0.7)',
            alerta: 'rgba(255, 193, 7, 0.7)',
            info: 'rgba(23, 162, 184, 0.7)',
            roxo: 'rgba(111, 66, 193, 0.7)',
            laranja: 'rgba(253, 126, 20, 0.7)'
        };

        // CONSTANTES DOS NOMES DOS CAMPOS (EXATAMENTE COMO NO BANCO/CSV)
        const K_CLIENTE = "Cliente";
        const K_DATA = "Data do plantão:  ";
        const K_DIA_SEMANA = "Dia da semana:";
        const K_TURNO = "Diurno ou noturno:";
        const K_INALATORIA = "INALATORIA";
        const K_MED_SC = "Medicação Subcultanea";
        const K_MED_VO = "Medicação VO ou Subligual";
        const K_MED_EV = "Medicação prescritas EV";
        const K_MED_IM = "Medicação prescritas IM";
        const K_MEDICO = "Nome do médico ";
        const K_REAVALIACOES = "Número Reavalições";
        const K_ATEND_NOVO = "Número de Novos atendimentos:";
        const K_RX = "Número de RX";
        const K_ECHO = "Número de ecocardiograma";
        const K_ELETRO = "Número de eletrocardiograma";
        const K_F_AMARELA = "Número de fichas amarelas";
        const K_F_AZUL = "Número de fichas azul";
        const K_F_BRANCA = "Número de fichas brancas";
        const K_F_LARANJA = "Número de fichas laranja";
        const K_F_VERDE = "Número de fichas verdes";
        const K_LABORATORIAIS = "Número de laboratoriais";
        const K_OFTALMICA = "OFTALMICA";
        const K_RETAL = "RETAL";
        const K_TOMOGRAFIAS = "Tomografias";
        const K_USG = "USG";
        const K_UNIDADE = "Unidade";

        function safeGet(data, key, isNumber = false) {
            const val = data[key];
            if (isNumber) {
                if (val === undefined || val === null || val === '') return 0;
                const num = Number(val);
                return isNaN(num) ? 0 : num;
            }
            return val !== undefined && val !== null ? String(val).trim() : '';
        }

        async function initDashboard() {
            toggleLoading(true);
            try {
                const snapshot = await db.collection(PRODUTIVIDADE_COLLECTION).get();
                allData = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const obj = {};
                    obj[K_CLIENTE] = safeGet(data, K_CLIENTE);
                    obj[K_DATA] = safeGet(data, K_DATA);
                    obj[K_DIA_SEMANA] = safeGet(data, K_DIA_SEMANA);
                    obj[K_TURNO] = safeGet(data, K_TURNO);
                    obj[K_INALATORIA] = safeGet(data, K_INALATORIA, true);
                    obj[K_MED_SC] = safeGet(data, K_MED_SC, true);
                    obj[K_MED_VO] = safeGet(data, K_MED_VO, true);
                    obj[K_MED_EV] = safeGet(data, K_MED_EV, true);
                    obj[K_MED_IM] = safeGet(data, K_MED_IM, true);
                    obj[K_MEDICO] = safeGet(data, K_MEDICO);
                    obj[K_REAVALIACOES] = safeGet(data, K_REAVALIACOES, true);
                    obj[K_ATEND_NOVO] = safeGet(data, K_ATEND_NOVO, true);
                    obj[K_RX] = safeGet(data, K_RX, true);
                    obj[K_ECHO] = safeGet(data, K_ECHO, true);
                    obj[K_ELETRO] = safeGet(data, K_ELETRO, true);
                    obj[K_F_AMARELA] = safeGet(data, K_F_AMARELA, true);
                    obj[K_F_AZUL] = safeGet(data, K_F_AZUL, true);
                    obj[K_F_BRANCA] = safeGet(data, K_F_BRANCA, true);
                    obj[K_F_LARANJA] = safeGet(data, K_F_LARANJA, true);
                    obj[K_F_VERDE] = safeGet(data, K_F_VERDE, true);
                    obj[K_LABORATORIAIS] = safeGet(data, K_LABORATORIAIS, true);
                    obj[K_OFTALMICA] = safeGet(data, K_OFTALMICA, true);
                    obj[K_RETAL] = safeGet(data, K_RETAL, true);
                    obj[K_TOMOGRAFIAS] = safeGet(data, K_TOMOGRAFIAS, true);
                    obj[K_USG] = safeGet(data, K_USG, true);
                    obj[K_UNIDADE] = safeGet(data, K_UNIDADE);
                    return obj;
                }).filter(item => item[K_MEDICO] !== '');

                populateFilters(allData);
                updateDashboard();
                enableFilters();
            } catch (error) {
                console.error("Erro ao buscar dados: ", error);
                alert("Erro ao carregar dados do banco de dados.");
            } finally {
                toggleLoading(false);
            }
        }

        function populateFilters(data) {
            const clientes = [...new Set(data.map(item => item[K_CLIENTE]))].sort();
            const unidades = [...new Set(data.map(item => item[K_UNIDADE]))].sort();
            const medicos = [...new Set(data.map(item => item[K_MEDICO]))].sort();
            const turnos = [...new Set(data.map(item => item[K_TURNO]))].sort();

            const fillSelect = (id, list, defaultText) => {
                const select = document.getElementById(id);
                select.innerHTML = id === 'filtroMedico' ? '' : `<option value="todos">${defaultText}</option>`;
                list.forEach(val => {
                    if (val) {
                        const opt = document.createElement('option');
                        opt.value = val;
                        opt.textContent = val;
                        select.appendChild(opt);
                    }
                });
            };

            fillSelect('filtroCliente', clientes, "Todos os Clientes");
            fillSelect('filtroUnidade', unidades, "Todas as Unidades");
            fillSelect('filtroMedico', medicos, "");
            fillSelect('filtroTurno', turnos, "Todos os Turnos");
        }

        function filterData(data) {
            const cliente = document.getElementById('filtroCliente').value;
            const unidade = document.getElementById('filtroUnidade').value;
            const medicosSelecionados = Array.from(document.getElementById('filtroMedico').selectedOptions).map(option => option.value);
            const turno = document.getElementById('filtroTurno').value;
            const dataFiltro = document.getElementById('filtroData').value;

            return data.filter(item => {
                const matchCliente = cliente === 'todos' || item[K_CLIENTE] === cliente;
                const matchUnidade = unidade === 'todos' || item[K_UNIDADE] === unidade;
                const matchMedico = medicosSelecionados.length === 0 || medicosSelecionados.includes(item[K_MEDICO]);
                const matchTurno = turno === 'todos' || item[K_TURNO] === turno;
                const matchData = !dataFiltro || item[K_DATA] >= dataFiltro;

                return matchCliente && matchUnidade && matchMedico && matchTurno && matchData;
            });
        }

        function generateKPIs(data) {
            const totalNovosAtendimentos = data.reduce((sum, item) => sum + item[K_ATEND_NOVO], 0);
            const totalReavaliacoes = data.reduce((sum, item) => sum + item[K_REAVALIACOES], 0);
            const somaGeral = totalNovosAtendimentos + totalReavaliacoes;

            const diurno = data.filter(item => item[K_TURNO].toLowerCase().includes('diurno')).reduce((sum, item) => sum + item[K_ATEND_NOVO], 0);
            const intermediario = data.filter(item => item[K_TURNO].toLowerCase().includes('intermediario')).reduce((sum, item) => sum + item[K_ATEND_NOVO], 0);
            const noturno = data.filter(item => item[K_TURNO].toLowerCase().includes('noturno')).reduce((sum, item) => sum + item[K_ATEND_NOVO], 0);

            document.getElementById('totalAtendimentosMedico').textContent = totalNovosAtendimentos.toLocaleString();
            document.getElementById('totalEV').textContent = totalReavaliacoes.toLocaleString();
            document.getElementById('totalAtendimentos').textContent = somaGeral.toLocaleString();
            
            document.getElementById('kpiDiurno').textContent = diurno.toLocaleString();
            document.getElementById('kpiIntermediario').textContent = intermediario.toLocaleString();
            document.getElementById('kpiNoturno').textContent = noturno.toLocaleString();
        }

        function createCharts(data) {
            if (produtividadePorMedicoChartInstance) produtividadePorMedicoChartInstance.destroy();
            if (atendimentosDiaSemanaChartInstance) atendimentosDiaSemanaChartInstance.destroy();
            if (examesPorMedicoChartInstance) examesPorMedicoChartInstance.destroy();
            if (medicacoesPorMedicoChartInstance) medicacoesPorMedicoChartInstance.destroy();
            if (fichasClassificacaoChartInstance) fichasClassificacaoChartInstance.destroy();
            if (medicacoesChartInstance) medicacoesChartInstance.destroy();

            // 1. Produtividade por Médico (Atend. Novos + Reavaliações)
            const medicosLabels = [...new Set(data.map(item => item[K_MEDICO]))];
            const medicosData = medicosLabels.map(medico => {
                const medicoRecords = data.filter(item => item[K_MEDICO] === medico);
                return medicoRecords.reduce((sum, item) => sum + item[K_ATEND_NOVO] + item[K_REAVALIACOES], 0);
            });

            produtividadePorMedicoChartInstance = new Chart(document.getElementById('produtividadePorMedicoChart'), {
                type: 'bar',
                data: {
                    labels: medicosLabels,
                    datasets: [{ label: 'Total Atendimentos', data: medicosData, backgroundColor: colors.primario }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // 2. Dia da Semana
            const diasLabels = ['Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado', 'Domingo'];
            const diasData = diasLabels.map(dia => {
                return data.filter(item => item[K_DIA_SEMANA] === dia).reduce((sum, item) => sum + item[K_ATEND_NOVO], 0);
            });

            atendimentosDiaSemanaChartInstance = new Chart(document.getElementById('atendimentosDiaSemanaChart'), {
                type: 'line',
                data: {
                    labels: diasLabels,
                    datasets: [{ label: 'Novos Atendimentos', data: diasData, borderColor: colors.sucesso, fill: false }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // 3. Exames por Médico
            const examesMedData = medicosLabels.map(medico => {
                const r = data.filter(item => item[K_MEDICO] === medico);
                return r.reduce((s, i) => s + i[K_RX] + i[K_ECHO] + i[K_ELETRO] + i[K_LABORATORIAIS] + i[K_TOMOGRAFIAS] + i[K_USG], 0);
            });

            examesPorMedicoChartInstance = new Chart(document.getElementById('examesPorMedicoChart'), {
                type: 'bar',
                data: {
                    labels: medicosLabels,
                    datasets: [{ label: 'Total Exames', data: examesMedData, backgroundColor: colors.roxo }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // 4. Medicações por Médico
            const medMedData = medicosLabels.map(medico => {
                const r = data.filter(item => item[K_MEDICO] === medico);
                return r.reduce((s, i) => s + i[K_MED_EV] + i[K_MED_IM] + i[K_MED_SC] + i[K_MED_VO] + i[K_INALATORIA] + i[K_OFTALMICA] + i[K_RETAL], 0);
            });

            medicacoesPorMedicoChartInstance = new Chart(document.getElementById('medicacoesPorMedicoChart'), {
                type: 'bar',
                data: {
                    labels: medicosLabels,
                    datasets: [{ label: 'Total Medicações', data: medMedData, backgroundColor: colors.laranja }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // 5. Fichas Classificação
            const fichasLabels = ['Branca', 'Azul', 'Verde', 'Amarela', 'Laranja'];
            const fichasData = [
                data.reduce((s, i) => s + i[K_F_BRANCA], 0),
                data.reduce((s, i) => s + i[K_F_AZUL], 0),
                data.reduce((s, i) => s + i[K_F_VERDE], 0),
                data.reduce((s, i) => s + i[K_F_AMARELA], 0),
                data.reduce((s, i) => s + i[K_F_LARANJA], 0)
            ];

            fichasClassificacaoChartInstance = new Chart(document.getElementById('fichasClassificacaoChart'), {
                type: 'pie',
                data: {
                    labels: fichasLabels,
                    datasets: [{ data: fichasData, backgroundColor: ['#eee', '#007bff', '#28a745', '#ffc107', '#fd7e14'] }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // 6. Medicações Geral
            const medsLabels = ['EV', 'IM', 'SC', 'VO', 'Inalatória', 'Outras'];
            const medsData = [
                data.reduce((s, i) => s + i[K_MED_EV], 0),
                data.reduce((s, i) => s + i[K_MED_IM], 0),
                data.reduce((s, i) => s + i[K_MED_SC], 0),
                data.reduce((s, i) => s + i[K_MED_VO], 0),
                data.reduce((s, i) => s + i[K_INALATORIA], 0),
                data.reduce((s, i) => s + i[K_OFTALMICA] + i[K_RETAL], 0)
            ];

            medicacoesChartInstance = new Chart(document.getElementById('medicacoesChart'), {
                type: 'doughnut',
                data: {
                    labels: medsLabels,
                    datasets: [{ data: medsData, backgroundColor: [colors.perigo, colors.laranja, colors.alerta, colors.sucesso, colors.info, colors.secundario] }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function renderDetailedTable(data) {
            const container = document.getElementById('detailedTableContainer');
            if (data.length === 0) {
                container.innerHTML = '<p class="text-center text-muted p-4 mb-0">Nenhum dado encontrado para os filtros selecionados.</p>';
                return;
            }

            const columns = [K_DATA, K_MEDICO, K_UNIDADE, K_TURNO, K_ATEND_NOVO, K_REAVALIACOES];
            let tableHTML = `<table class="table table-striped table-hover table-sm"><thead><tr>`;
            columns.forEach(col => tableHTML += `<th>${col}</th>`);
            tableHTML += `</tr></thead><tbody>`;

            data.forEach(row => {
                tableHTML += `<tr>`;
                columns.forEach(col => {
                    let val = row[col];
                    if (col === K_DATA && val) {
                        const parts = val.split('-');
                        if (parts.length === 3) val = `${parts[2]}/${parts[1]}/${parts[0]}`;
                    }
                    tableHTML += `<td>${val || '-'}</td>`;
                });
                tableHTML += `</tr>`;
            });
            tableHTML += `</tbody></table>`;
            container.innerHTML = tableHTML;
        }

        function updateDashboard() {
            const filtered = filterData(allData);
            const alertEl = document.getElementById('filterAlert');
            if (filtered.length === 0) {
                alertEl.style.display = 'block';
                generateKPIs([]);
                createCharts([]);
                renderDetailedTable([]);
            } else {
                alertEl.style.display = 'none';
                generateKPIs(filtered);
                createCharts(filtered);
                renderDetailedTable(filtered);
            }
        }

        function toggleLoading(show) { document.getElementById('loadingMessage').style.display = show ? 'block' : 'none'; }
        function enableFilters() {
            ['filtroCliente', 'filtroUnidade', 'filtroMedico', 'filtroTurno', 'filtroData', 'applyFiltersBtn', 'clearFiltersBtn'].forEach(id => {
                document.getElementById(id).disabled = false;
            });
        }

        document.getElementById('applyFiltersBtn').onclick = updateDashboard;
        document.getElementById('clearFiltersBtn').onclick = () => {
            document.getElementById('filtroCliente').value = 'todos';
            document.getElementById('filtroUnidade').value = 'todos';
            document.getElementById('filtroMedico').selectedIndex = -1;
            document.getElementById('filtroTurno').value = 'todos';
            document.getElementById('filtroData').value = '';
            updateDashboard();
        };

        initDashboard();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>