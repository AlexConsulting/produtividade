<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Produtividade Clínica</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script> 

    <style>
        body { background-color: #f8f9fa; }
        .dashboard-header { background-color: #007bff; color: white; padding: 20px 0; margin-bottom: 30px; }
        
        /* --- ESTILO KPI CARD --- */
        .kpi-card { 
            border-left: 5px solid #007bff; 
            border-radius: .5rem; 
            transition: transform 0.2s, box-shadow 0.2s;
            background-color: white; 
            box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,.05);
            min-height: 120px;
            display: flex; 
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .kpi-card:hover { transform: translateY(-3px); box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15); }
        
        .kpi-card h5 {
            word-wrap: break-word; 
            text-align: center;
            font-size: 0.9rem; 
            min-height: 40px; 
            margin-bottom: 0.25rem;
        }
        
        .kpi-card p { margin-top: 5px; }
        
        /* --- ESTILO GERAL --- */
        .chart-container { 
            background-color: white; 
            padding: 20px; 
            border-radius: .5rem; 
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15); 
            position: relative; 
        }
        .form-select, .form-control { border-radius: .3rem; }
        .alert-loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }
        #detailedTableContainer thead th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 10;
        }
    </style>
</head>
<body>

    <header class="dashboard-header">
        <div class="container">
            <h1 class="text-center">Painel de Indicadores de Produtividade Clínica</h1>
            <p class="text-center">Dados carregados do Banco de Dados</p>
            
            <div class="text-center mt-3">
                <a href="index.html" class="btn btn-sm btn-light">
                    &larr; Voltar à Página Inicial
                </a>
            </div>
        </div>
    </header>

    <main class="container">
        
        <div id="loadingMessage" class="alert alert-info alert-loading" role="alert" style="display:none;">
            <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div>
            Carregando dados do banco de dados...
        </div>
        
        <div id="filterAlert" class="alert alert-warning text-center" role="alert" style="display:none;">
            <strong>⚠️ Nenhum dado encontrado.</strong> Verifique os filtros de Data e Médico.
        </div>
        
        <section id="filters" class="mb-4 p-4 chart-container">
            <h4 class="mb-3">Filtros de Visualização</h4>
            <div class="row g-3 mb-3">
                <div class="col-md-6 col-lg-3">
                    <label for="filtroCliente" class="form-label fw-bold">1. Filtrar por Cliente:</label>
                    <select class="form-select" id="filtroCliente" disabled>
                        <option value="todos">Carregando...</option>
                    </select>
                </div>
                
                <div class="col-md-6 col-lg-3">
                    <label for="filtroUnidade" class="form-label fw-bold">2. Filtrar por Unidade:</label>
                    <select class="form-select" id="filtroUnidade" disabled>
                        <option value="todos">Carregando...</option>
                    </select>
                </div>

                <div class="col-md-12 col-lg-6">
                    <label for="filtroMedico" class="form-label fw-bold">3. Filtrar por Médico (Use Ctrl/Cmd para múltiplos):</label>
                    <select class="form-select" id="filtroMedico" multiple size="5" disabled>
                        <option value="todos">Carregando...</option>
                    </select>
                </div>
            </div>
            
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="filtroTurno" class="form-label fw-bold">4. Filtrar por Turno:</label>
                    <select class="form-select" id="filtroTurno" disabled>
                        <option value="todos">Carregando...</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="filtroData" class="form-label fw-bold">5. Filtrar por Data (A partir de):</label>
                    <input type="date" class="form-control" id="filtroData" disabled>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-md-6">
                    <button class="btn btn-primary w-100" id="applyFiltersBtn" disabled>Aplicar Filtros</button>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-secondary w-100" id="clearFiltersBtn" disabled>Limpar Filtros</button>
                </div>
            </div>
            <div class="row g-3 mt-3">
                <div class="col-md-12">
                    <label for="dbFileName" class="form-label fw-bold" id="data-source-label">FONTE DE DADOS:</label>
                    <input class="form-control" type="text" id="dbFileName" value="Coleção: produtividade" readonly style="color:#007bff;">
                </div>
            </div>
        </section>

        <section id="kpis" class="mb-5">
            <div class="row text-center">
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card kpi-card p-3 shadow-sm" style="border-left-color: #198754 !important;">
                        <h5 class="card-title text-muted">Novos Atendimentos</h5>
                        <p class="card-text fs-3 fw-bold text-success" id="totalAtendimentosMedico">0</p>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card kpi-card p-3 shadow-sm" style="border-left-color: #dc3545 !important;">
                        <h5 class="card-title text-muted">Total de Reavaliações</h5>
                        <p class="card-text fs-3 fw-bold text-danger" id="totalEV">0</p>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card kpi-card p-3 shadow-sm" style="border-left-color: #0d6efd !important;">
                        <h5 class="card-title text-muted">Atend. + Reavaliações</h5>
                        <p class="card-text fs-3 fw-bold text-primary" id="totalAtendimentos">0</p>
                    </div>
                </div>
            </div>

            <h5 class="mt-4 mb-3 text-muted">Novos Atendimentos por Turno</h5>
            <div class="row text-center">
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card kpi-card p-3 shadow-sm" style="border-left-color: #007bff !important;">
                        <h5 class="card-title text-muted">Novos Atend. - DIURNO</h5>
                        <p class="card-text fs-3 fw-bold text-primary" id="kpiDiurno">0</p>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card kpi-card p-3 shadow-sm" style="border-left-color: #ffc107 !important;">
                        <h5 class="card-title text-muted">Novos Atend. - INTERMEDIÁRIO</h5>
                        <p class="card-text fs-3 fw-bold text-warning" id="kpiIntermediario">0</p>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card kpi-card p-3 shadow-sm" style="border-left-color: #28a745 !important;">
                        <h5 class="card-title text-muted">Novos Atend. - NOTURNO</h5>
                        <p class="card-text fs-3 fw-bold text-success" id="kpiNoturno">0</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="charts">
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="chart-container" style="height: 400px;">
                        <h5 class="text-center mb-3">Produtividade por Médico (Atend. Totais)</h5>
                        <canvas id="produtividadePorMedicoChart"></canvas>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="chart-container" style="height: 400px;">
                        <h5 class="text-center mb-3">Atendimentos por Dia da Semana</h5>
                        <canvas id="atendimentosDiaSemanaChart"></canvas>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="chart-container" style="height: 400px;">
                        <h5 class="text-center mb-3">Exames Solicitados por Médico</h5>
                        <canvas id="examesPorMedicoChart"></canvas>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="chart-container" style="height: 400px;">
                        <h5 class="text-center mb-3">Medicações Prescritas por Médico</h5>
                        <canvas id="medicacoesPorMedicoChart"></canvas>
                    </div>
                </div>
                
                <div class="col-12 mb-4">
                    <div class="chart-container" style="height: 300px;">
                        <h5 class="text-center mb-3">Fichas de Classificação de Risco (Total Geral)</h5>
                        <canvas id="fichasClassificacaoChart"></canvas>
                    </div>
                </div>

                <div class="col-12 mb-4">
                    <div class="chart-container" style="height: 300px;">
                        <h5 class="text-center mb-3">Medicações Prescritas (Total Geral)</h5>
                        <canvas id="medicacoesChart"></canvas>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="detailed-data" class="mb-5">
            <div class="chart-container p-4">
                <h4 class="mb-3" id="detailed-data-title">Detalhes da Produtividade</h4>
                <div id="detailedTableContainer" style="overflow-x: auto; max-height: 500px; border: 1px solid #ddd; border-radius: .3rem;">
                    <p class="text-center text-muted p-4 mb-0">Selecione um médico ou aplique filtros para carregar os dados detalhados.</p>
                </div>
            </div>
        </section>
    </main>
    <footer class="text-center text-muted py-3">Dashboard de Produtividade</footer>

<script>
        // CONFIGURAÇÃO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyA_22plUsZfyzW909W1ePkCJxq-KdUydcw",
            authDomain: "produtividade-4d98e.firebaseapp.com",
            projectId: "produtividade-4d98e",
            storageBucket: "produtividade-4d98e.firebasestorage.app",
            messagingSenderId: "642824868640",
            appId: "1:642824868640:web:3e6ea0e09c41ec09023d45"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // DEFINIÇÃO EXATA DOS CAMPOS DO BANCO DE DADOS
        const K = {
            CLIENTE: "Cliente",
            DATA: "Data do plantão:  ",
            DIA_SEMANA: "Dia da semana:",
            TURNO: "Diurno ou noturno:",
            MEDICO: "Nome do médico ",
            UNIDADE: "Unidade",
            ATEND_NOVO: "Número de Novos atendimentos:",
            REAVALIACOES: "Número Reavalições",
            // Fichas
            F_BRANCA: "Número de fichas brancas",
            F_AZUL: "Número de fichas azul",
            F_VERDE: "Número de fichas verdes",
            F_AMARELA: "Número de fichas amarelas",
            F_LARANJA: "Número de fichas laranja",
            // Exames
            ECHO: "Número de ecocardiograma",
            ELETRO: "Número de eletrocardiograma",
            LAB: "Número de laboratoriais",
            RX: "Número de RX",
            TOMO: "Tomografias",
            USG: "USG",
            // Medicações
            MED_EV: "Medicação prescritas EV",
            MED_IM: "Medicação prescritas IM",
            MED_SC: "Medicação Subcultanea",
            MED_VO: "Medicação VO ou Subligual",
            RETAL: "RETAL",
            INALATORIA: "INALATORIA",
            OFTALMICA: "OFTALMICA"
        };

        let allData = [];
        let chartInstances = {};

        // INICIALIZAÇÃO
        async function initDashboard() {
            document.getElementById('loadingMessage').style.display = 'block';
            try {
                const snapshot = await db.collection('produtividade').get();
                allData = snapshot.docs.map(doc => {
                    const d = doc.data();
                    const row = {};
                    
                    // Processamento de Strings e Números para todos os campos
                    Object.keys(K).forEach(key => {
                        const dbKey = K[key];
                        if (["ATEND_NOVO", "REAVALIACOES", "F_BRANCA", "F_AZUL", "F_VERDE", "F_AMARELA", "F_LARANJA", "ECHO", "ELETRO", "LAB", "RX", "TOMO", "USG", "MED_EV", "MED_IM", "MED_SC", "MED_VO", "RETAL", "INALATORIA", "OFTALMICA"].includes(key)) {
                            row[dbKey] = Number(d[dbKey]) || 0;
                        } else {
                            row[dbKey] = d[dbKey] ? String(d[dbKey]).trim() : "";
                        }
                    });
                    return row;
                }).filter(r => r[K.MEDICO] !== "");

                populateFilters();
                updateDashboard();
                enableUI();
            } catch (error) {
                console.error("Erro:", error);
                alert("Falha ao carregar dados do Firestore.");
            } finally {
                document.getElementById('loadingMessage').style.display = 'none';
            }
        }

        function populateFilters() {
            const getUnicos = (campo) => [...new Set(allData.map(d => d[campo]))].sort();
            
            const fillSelect = (id, lista, textoTodos) => {
                const sel = document.getElementById(id);
                sel.innerHTML = id === 'filtroMedico' ? '' : `<option value="todos">${textoTodos}</option>`;
                lista.forEach(val => { if(val) sel.add(new Option(val, val)); });
            };

            fillSelect('filtroCliente', getUnicos(K.CLIENTE), "Todos os Clientes");
            fillSelect('filtroUnidade', getUnicos(K.UNIDADE), "Todas as Unidades");
            fillSelect('filtroMedico', getUnicos(K.MEDICO), "");
            fillSelect('filtroTurno', getUnicos(K.TURNO), "Todos os Turnos");
        }

        function filterData() {
            const fCliente = document.getElementById('filtroCliente').value;
            const fUnidade = document.getElementById('filtroUnidade').value;
            const fTurno = document.getElementById('filtroTurno').value;
            const fData = document.getElementById('filtroData').value;
            const fMedicos = Array.from(document.getElementById('filtroMedico').selectedOptions).map(o => o.value);

            return allData.filter(d => {
                const mCliente = fCliente === 'todos' || d[K.CLIENTE] === fCliente;
                const mUnidade = fUnidade === 'todos' || d[K.UNIDADE] === fUnidade;
                const mTurno = fTurno === 'todos' || d[K.TURNO] === fTurno;
                const mData = !fData || d[K.DATA] >= fData;
                const mMedico = fMedicos.length === 0 || fMedicos.includes(d[K.MEDICO]);
                return mCliente && mUnidade && mTurno && mData && mMedico;
            });
        }

        function updateDashboard() {
            const data = filterData();
            
            // 1. KPIs
            const novos = data.reduce((s, r) => s + r[K.ATEND_NOVO], 0);
            const reaval = data.reduce((s, r) => s + r[K.REAVALIACOES], 0);
            document.getElementById('totalAtendimentosMedico').innerText = novos.toLocaleString();
            document.getElementById('totalEV').innerText = reaval.toLocaleString();
            document.getElementById('totalAtendimentos').innerText = (novos + reaval).toLocaleString();

            // KPIs por Turno
            const calcTurno = (t) => data.filter(d => d[K.TURNO].toUpperCase().includes(t)).reduce((s, r) => s + r[K.ATEND_NOVO], 0);
            document.getElementById('kpiDiurno').innerText = calcTurno("DIURNO");
            document.getElementById('kpiIntermediario').innerText = calcTurno("INTERMEDIARIO");
            document.getElementById('kpiNoturno').innerText = calcTurno("NOTURNO");

            // 2. Gráficos
            renderAllCharts(data);

            // 3. Tabela
            renderTable(data);

            document.getElementById('filterAlert').style.display = data.length === 0 ? 'block' : 'none';
        }

        function renderAllCharts(data) {
            const clearChart = (id) => { if(chartInstances[id]) chartInstances[id].destroy(); };

            // Produtividade por Médico
            clearChart('prod');
            const medAgrup = {};
            data.forEach(d => { medAgrup[d[K.MEDICO]] = (medAgrup[d[K.MEDICO]] || 0) + d[K.ATEND_NOVO] + d[K.REAVALIACOES]; });
            chartInstances['prod'] = new Chart(document.getElementById('produtividadePorMedicoChart'), {
                type: 'bar',
                data: { labels: Object.keys(medAgrup), datasets: [{ label: 'Total', data: Object.values(medAgrup), backgroundColor: '#007bff' }] }
            });

            // Dia da Semana
            clearChart('dias');
            const diasAgrup = {};
            data.forEach(d => { diasAgrup[d[K.DIA_SEMANA]] = (diasAgrup[d[K.DIA_SEMANA]] || 0) + d[K.ATEND_NOVO]; });
            chartInstances['dias'] = new Chart(document.getElementById('atendimentosDiaSemanaChart'), {
                type: 'line',
                data: { labels: Object.keys(diasAgrup), datasets: [{ label: 'Novos Atendimentos', data: Object.values(diasAgrup), borderColor: '#198754' }] }
            });

            // Fichas de Classificação
            clearChart('fichas');
            const fichas = {
                Verde: data.reduce((s, r) => s + r[K.F_VERDE], 0),
                Amarela: data.reduce((s, r) => s + r[K.F_AMARELA], 0),
                Laranja: data.reduce((s, r) => s + r[K.F_LARANJA], 0),
                Azul: data.reduce((s, r) => s + r[K.F_AZUL], 0),
                Branca: data.reduce((s, r) => s + r[K.F_BRANCA], 0)
            };
            chartInstances['fichas'] = new Chart(document.getElementById('fichasClassificacaoChart'), {
                type: 'pie',
                data: { labels: Object.keys(fichas), datasets: [{ data: Object.values(fichas), backgroundColor: ['green', 'yellow', 'orange', 'blue', 'gray'] }] }
            });

            // Exames por Médico
            clearChart('examesMed');
            const exMedMap = {};
            data.forEach(d => {
                const totalEx = d[K.RX] + d[K.ECHO] + d[K.ELETRO] + d[K.LAB] + d[K.TOMO] + d[K.USG];
                exMedMap[d[K.MEDICO]] = (exMedMap[d[K.MEDICO]] || 0) + totalEx;
            });
            chartInstances['examesMed'] = new Chart(document.getElementById('examesPorMedicoChart'), {
                type: 'bar',
                data: { labels: Object.keys(exMedMap), datasets: [{ label: 'Exames Solicitados', data: Object.values(exMedMap), backgroundColor: '#6f42c1' }] }
            });

            // Medicações (Total Geral)
            clearChart('medsTotal');
            const meds = {
                EV: data.reduce((s, r) => s + r[K.MED_EV], 0),
                IM: data.reduce((s, r) => s + r[K.MED_IM], 0),
                SC: data.reduce((s, r) => s + r[K.MED_SC], 0),
                VO: data.reduce((s, r) => s + r[K.MED_VO], 0),
                Outros: data.reduce((s, r) => s + r[K.RETAL] + r[K.INALATORIA] + r[K.OFTALMICA], 0)
            };
            chartInstances['medsTotal'] = new Chart(document.getElementById('medicacoesChart'), {
                type: 'doughnut',
                data: { labels: Object.keys(meds), datasets: [{ data: Object.values(meds), backgroundColor: ['#dc3545', '#fd7e14', '#ffc107', '#20c997', '#6c757d'] }] }
            });
            
            // Medicações por Médico
            clearChart('medsMed');
            const medMedMap = {};
            data.forEach(d => {
                const totalMed = d[K.MED_EV] + d[K.MED_IM] + d[K.MED_SC] + d[K.MED_VO] + d[K.RETAL] + d[K.INALATORIA] + d[K.OFTALMICA];
                medMedMap[d[K.MEDICO]] = (medMedMap[d[K.MEDICO]] || 0) + totalMed;
            });
            chartInstances['medsMed'] = new Chart(document.getElementById('medicacoesPorMedicoChart'), {
                type: 'bar',
                data: { labels: Object.keys(medMedMap), datasets: [{ label: 'Prescrições', data: Object.values(medMedMap), backgroundColor: '#fd7e14' }] }
            });
        }

        function renderTable(data) {
            const container = document.getElementById('detailedTableContainer');
            if(!data.length) { container.innerHTML = '<p class="text-center p-4">Sem dados para os filtros selecionados.</p>'; return; }
            
            let html = '<table class="table table-hover table-sm"><thead><tr><th>Data</th><th>Médico</th><th>Turno</th><th>Novos</th><th>Reaval.</th><th>Exames</th><th>Meds</th></tr></thead><tbody>';
            data.forEach(r => {
                const totalEx = r[K.RX] + r[K.ECHO] + r[K.ELETRO] + r[K.LAB] + r[K.TOMO] + r[K.USG];
                const totalMed = r[K.MED_EV] + r[K.MED_IM] + r[K.MED_SC] + r[K.MED_VO];
                html += `<tr><td>${r[K.DATA]}</td><td>${r[K.MEDICO]}</td><td>${r[K.TURNO]}</td><td>${r[K.ATEND_NOVO]}</td><td>${r[K.REAVALIACOES]}</td><td>${totalEx}</td><td>${totalMed}</td></tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function enableUI() {
            ['filtroCliente', 'filtroUnidade', 'filtroMedico', 'filtroTurno', 'filtroData', 'applyFiltersBtn', 'clearFiltersBtn'].forEach(id => {
                document.getElementById(id).disabled = false;
            });
        }

        document.getElementById('applyFiltersBtn').onclick = updateDashboard;
        document.getElementById('clearFiltersBtn').onclick = () => {
            document.getElementById('filtroCliente').value = 'todos';
            document.getElementById('filtroUnidade').value = 'todos';
            document.getElementById('filtroTurno').value = 'todos';
            document.getElementById('filtroData').value = '';
            document.getElementById('filtroMedico').selectedIndex = -1;
            updateDashboard();
        };

        window.onload = initDashboard;
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>