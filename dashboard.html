<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Produtividade Clínica</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script> 

    <style>
        body { background-color: #f8f9fa; }
        .dashboard-header { background-color: #007bff; color: white; padding: 20px 0; margin-bottom: 30px; }
        
        /* --- ESTILO KPI CARD --- */
        .kpi-card { 
            border-left: 5px solid #007bff; 
            border-radius: .5rem; 
            transition: transform 0.2s, box-shadow 0.2s;
            background-color: white; 
            box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,.05);
            min-height: 120px;
            display: flex; 
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .kpi-card:hover { transform: translateY(-3px); box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15); }
        
        .kpi-card h5 {
            word-wrap: break-word; 
            text-align: center;
            font-size: 0.9rem; 
            min-height: 40px; 
            margin-bottom: 0.25rem;
        }
        
        .kpi-card p { margin-top: 5px; }
        
        /* --- ESTILO GERAL --- */
        .chart-container { 
            background-color: white; 
            padding: 20px; 
            border-radius: .5rem; 
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15); 
            position: relative; 
        }
        .form-select, .form-control { border-radius: .3rem; }
        .alert-loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }
        /* Estilo para fixar o cabeçalho da tabela de detalhes */
        #detailedTableContainer thead th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa; /* Cor de fundo para o cabeçalho fixo */
            z-index: 10;
        }
    </style>
</head>
<body>

    <header class="dashboard-header">
        <div class="container">
            <h1 class="text-center">Painel de Indicadores de Produtividade Clínica</h1>
            <p class="text-center">Dados carregados do Banco de Dados</p>
            
            <div class="text-center mt-3">
                <a href="index.html" class="btn btn-sm btn-light">
                    &larr; Voltar à Página Inicial
                </a>
            </div>
            
        </div>
    </header>

    <main class="container">
        
        <div id="loadingMessage" class="alert alert-info alert-loading" role="alert" style="display:none;">
            <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div>
            Carregando dados do banco de dados...
        </div>
        
        <div id="filterAlert" class="alert alert-warning text-center" role="alert" style="display:none;">
            <strong>⚠️ Nenhum dado encontrado.</strong> O filtro de Data (A partir de) e/ou Médico não retornou registros.
        </div>
        
        <section id="filters" class="mb-4 p-4 chart-container">
            <h4 class="mb-3">Filtros de Visualização</h4>
            <div class="row g-3 mb-3">
                
                <div class="col-md-6 col-lg-3">
                    <label for="filtroCliente" class="form-label fw-bold">1. Filtrar por Cliente:</label>
                    <select class="form-select" id="filtroCliente" disabled>
                        <option value="todos">Carregando...</option>
                    </select>
                </div>
                
                <div class="col-md-6 col-lg-3">
                    <label for="filtroUnidade" class="form-label fw-bold">2. Filtrar por Unidade:</label>
                    <select class="form-select" id="filtroUnidade" disabled>
                        <option value="todos">Carregando...</option>
                    </select>
                </div>

                <div class="col-md-12 col-lg-6">
                    <label for="filtroMedico" class="form-label fw-bold">3. Filtrar por Médico (Use Ctrl/Cmd para múltiplos):</label>
                    <select class="form-select" id="filtroMedico" multiple size="5" disabled>
                        <option value="todos">Carregando...</option>
                    </select>
                </div>
            </div>
            
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="filtroTurno" class="form-label fw-bold">4. Filtrar por Turno:</label>
                    <select class="form-select" id="filtroTurno" disabled>
                        <option value="todos">Carregando...</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="filtroData" class="form-label fw-bold">5. Filtrar por Data (A partir de):</label>
                    <input type="date" class="form-control" id="filtroData" disabled>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-md-6">
                    <button class="btn btn-primary w-100" id="applyFiltersBtn" disabled>Aplicar Filtros</button>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-secondary w-100" id="clearFiltersBtn" disabled>Limpar Filtros</button>
                </div>
            </div>
            <div class="row g-3 mt-3">
                <div class="col-md-12">
                    <label for="dbFileName" class="form-label fw-bold" id="data-source-label">FONTE DE DADOS:</label>
                    <input class="form-control" type="text" id="dbFileName" value="Coleção: produtividade" readonly style="color:#007bff;">
                </div>
            </div>

        </section>

        <section id="kpis" class="mb-5">
            <div class="row text-center">
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card kpi-card p-3 shadow-sm">
                        <h5 class="card-title text-muted">Total Geral de Atendimentos</h5>
                        <p class="card-text fs-3 fw-bold text-primary" id="totalAtendimentos">0</p>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card kpi-card p-3 shadow-sm" id="kpi-atendimento-medico">
                        <h5 class="card-title text-muted">Novos Atendimentos</h5>
                        <p class="card-text fs-3 fw-bold text-success" id="totalAtendimentosMedico">0</p>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card kpi-card p-3 shadow-sm">
                        <h5 class="card-title text-muted">Total de Reavaliações</h5>
                        <p class="card-text fs-3 fw-bold text-danger" id="totalEV">0</p>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card kpi-card p-3 shadow-sm">
                        <h5 class="card-title text-muted">Atend. + Reavaliações</h5>
                        <p class="card-text fs-3 fw-bold text-warning" id="totalEcocardiogramas">0</p>
                    </div>
                </div>
            </div>

            <h5 class="mt-4 mb-3 text-muted">Novos Atendimentos por Turno</h5>
            <div class="row text-center">
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card kpi-card p-3 shadow-sm" style="border-left-color: #007bff !important;">
                        <h5 class="card-title text-muted">Novos Atend. - DIURNO</h5>
                        <p class="card-text fs-3 fw-bold text-primary" id="kpiDiurno">0</p>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card kpi-card p-3 shadow-sm" style="border-left-color: #ffc107 !important;">
                        <h5 class="card-title text-muted">Novos Atend. - INTERMEDIÁRIO</h5>
                        <p class="card-text fs-3 fw-bold text-warning" id="kpiIntermediario">0</p>
                    </div>
                </div>
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card kpi-card p-3 shadow-sm" style="border-left-color: #28a745 !important;">
                        <h5 class="card-title text-muted">Novos Atend. - NOTURNO</h5>
                        <p class="card-text fs-3 fw-bold text-success" id="kpiNoturno">0</p>
                    </div>
                </div>
            </div>
            
        </section>

        <section id="charts">
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="chart-container" style="height: 400px;">
                        <h5 class="text-center mb-3">Produtividade por Médico (Atend. Totais)</h5>
                        <canvas id="produtividadePorMedicoChart"></canvas>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="chart-container" style="height: 400px;">
                        <h5 class="text-center mb-3">Atendimentos por Dia da Semana</h5>
                        <canvas id="atendimentosDiaSemanaChart"></canvas>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="chart-container" style="height: 400px;">
                        <h5 class="text-center mb-3">Exames Solicitados por Médico</h5>
                        <canvas id="examesPorMedicoChart"></canvas>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="chart-container" style="height: 400px;">
                        <h5 class="text-center mb-3">Medicações Prescritas por Médico</h5>
                        <canvas id="medicacoesPorMedicoChart"></canvas>
                    </div>
                </div>
                
                <div class="col-12 mb-4">
                    <div class="chart-container" style="height: 300px;">
                        <h5 class="text-center mb-3">Fichas de Classificação de Risco (Total Geral)</h5>
                        <canvas id="fichasClassificacaoChart"></canvas>
                    </div>
                </div>

                <div class="col-12 mb-4">
                    <div class="chart-container" style="height: 300px;">
                        <h5 class="text-center mb-3">Medicações Prescritas (Total Geral)</h5>
                        <canvas id="medicacoesChart"></canvas>
                    </div>
                </div>
            </div>
        </section>
        
        <section id="detailed-data" class="mb-5">
            <div class="chart-container p-4">
                <h4 class="mb-3" id="detailed-data-title">Detalhes da Produtividade</h4>
                <div id="detailedTableContainer" style="overflow-x: auto; max-height: 500px; border: 1px solid #ddd; border-radius: .3rem;">
                    <p class="text-center text-muted p-4 mb-0">Selecione um médico ou aplique filtros para carregar os dados detalhados.</p>
                </div>
            </div>
        </section>
        </main>
    <footer class="text-center text-muted py-3">Dashboard de Produtividade</footer>

    <script>
        // FIREBASE CONFIGURAÇÃO
        const firebaseConfig = {
            apiKey: "AIzaSyA_22plUsZfyzW909W1ePkCJxq-KdUydcw",
            authDomain: "produtividade-4d98e.firebaseapp.com",
            projectId: "produtividade-4d98e",
            storageBucket: "produtividade-4d98e.firebasestorage.app",
            messagingSenderId: "642824868640",
            appId: "1:642824868640:web:3e6ea0e09c41ec09023d45",
            measurementId: "G-489RSTNQVT"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const PRODUTIVIDADE_COLLECTION = 'produtividade'; 
        // FIM FIREBASE CONFIGURAÇÃO
        
        let allData = [];
        let examesPorMedicoChartInstance;
        let medicacoesPorMedicoChartInstance;
        let produtividadePorMedicoChartInstance;
        let atendimentosDiaSemanaChartInstance;
        let medicacoesChartInstance;
        let fichasClassificacaoChartInstance; 

        const colors = {
            primario: 'rgba(0, 123, 255, 0.7)', // Azul
            secundario: 'rgba(40, 167, 69, 0.7)', // Verde
            amarelo: 'rgba(255, 193, 7, 0.7)', // Amarelo
            vermelho: 'rgba(220, 53, 69, 0.7)', // Vermelho/Perigo
            roxo: 'rgba(108, 99, 255, 0.7)', 
            ciano: 'rgba(23, 162, 184, 0.7)',
            cinza: 'rgba(108, 117, 125, 0.7)', // Cinza/Secundário
            laranja: 'rgba(253, 126, 20, 0.7)' // Laranja
        };

        // --- DEFINIÇÃO DAS CHAVES INTERNAS (CHAVES LIMPAS PARA USO NO JS) ---
        // (IDÊNTICO AO SEU ORIGINAL)
        const K_DATA = 'data';
        const K_MEDICO = 'medico'; 
        const K_ATEND_TOTAL = 'atend_total'; 
        const K_ATEND_NOVO = 'atend_novo'; 
        const K_REAVALIACOES = 'reavaliacoes'; 
        const K_TOTAL_GERAL = 'total_geral_completo'; 
        const K_ECHO = 'echo';
        const K_ELETRO = 'eletro';
        const K_LAB = 'lab';
        const K_RX = 'rx';
        const K_TOMO = 'tomo';
        const K_USG = 'usg';
        const K_MED_EV = 'med_ev';
        const K_MED_IM = 'med_im';
        const K_MED_SUBCUT = 'med_subcut';
        const K_MED_VO = 'med_vo';
        const K_MED_OFTAL = 'med_oftal';
        const K_MED_INAL = 'med_inal';
        const K_DIA_SEMANA = 'dia_semana';
        const K_TURNO = 'turno'; 
        const K_CLIENTE = 'cliente'; 
        const K_UNIDADE = 'unidade'; 
        const K_FICHA_VERDE = 'ficha_verde';
        const K_FICHA_AMARELA = 'ficha_amarela';
        const K_FICHA_LARANJA = 'ficha_laranja';
        const K_FICHA_AZUL = 'ficha_azul';
        const K_FICHA_BRANCA = 'ficha_branca';
        
        // --- CHAVES DE CORRESPONDÊNCIA PARA ENCONTRAR COLUNAS NO DB (IGNORADO/MANTIDO APENAS POR REFERÊNCIA) ---
        // (IDÊNTICO AO SEU ORIGINAL, MAS AGORA É MANUALMENTE MANTIDO PELA INITDASHBOARD)
        const COLUMN_MAP_KEYS = {
    [K_DATA]: "Data do plantão:  ",
    [K_TURNO]: "Diurno ou noturno:",
    [K_DIA_SEMANA]: "Dia da semana:",
    [K_MEDICO]: "Nome do médico ",
    [K_ATEND_NOVO]: "Número de Novos atendimentos:",
    [K_REAVALIACOES]: "Número Reavalições",
    [K_FICHA_BRANCA]: "Número de fichas brancas",
    [K_FICHA_AZUL]: "Número de fichas azul",
    [K_FICHA_VERDE]: "Número de fichas verdes",
    [K_FICHA_AMARELA]: "Número de fichas amarelas",
    [K_FICHA_LARANJA]: "Número de fichas laranja",
    [K_LAB]: "Número de laboratoriais",
    [K_RX]: "Número de RX",
    [K_TOMO]: "Tomografias",
    [K_USG]: "USG",
    [K_MED_EV]: "Medicação prescritas EV",
    [K_MED_IM]: "Medicação prescritas IM",
    [K_MED_SUBCUT]: "Medicação Subcultanea",
    [K_MED_VO]: "Medicação VO ou Subligual",
    [K_MED_INAL]: "INALATORIA",
    [K_MED_OFTAL]: "OFTALMICA"
};

        // --- CHAVES E ORDEM PARA EXIBIÇÃO NA TABELA DE DETALHES ---
        // (IDÊNTICO AO SEU ORIGINAL)
        const DISPLAY_COLUMNS = {
            [K_DATA]: 'Data',
            [K_CLIENTE]: 'Cliente', 
            [K_UNIDADE]: 'Unidade', 
            [K_MEDICO]: 'Médico',
            [K_TURNO]: 'Turno', 
            [K_ATEND_NOVO]: 'Novos Atend.',
            [K_REAVALIACOES]: 'Reavaliações',
            [K_TOTAL_GERAL]: 'Total Geral (N+R)',
            [K_ATEND_TOTAL]: 'Atend. Total (Orig.)',
            [K_DIA_SEMANA]: 'Dia da Semana',
            [K_ECHO]: 'Echo',
            [K_ELETRO]: 'Eletro',
            [K_LAB]: 'Lab',
            [K_RX]: 'RX',
            [K_TOMO]: 'Tomo',
            [K_USG]: 'USG',
            [K_MED_EV]: 'Med. EV',
            [K_MED_IM]: 'Med. IM',
            [K_MED_SUBCUT]: 'Med. Subcut',
            [K_MED_VO]: 'Med. VO',
            [K_MED_OFTAL]: 'Med. Oftál',
            [K_MED_INAL]: 'Med. Inal',
            [K_FICHA_VERDE]: 'Ficha V.',
            [K_FICHA_AMARELA]: 'Ficha A.',
            [K_FICHA_LARANJA]: 'Ficha L.',
            [K_FICHA_AZUL]: 'Ficha Az.',
            [K_FICHA_BRANCA]: 'Ficha B.'
        };

        const COLUMN_ORDER = [
            K_DATA, K_CLIENTE, K_UNIDADE, K_MEDICO, K_TURNO, K_DIA_SEMANA, 
            K_ATEND_NOVO, K_REAVALIACOES, K_TOTAL_GERAL, K_ATEND_TOTAL, 
            K_FICHA_VERDE, K_FICHA_AMARELA, K_FICHA_LARANJA, K_FICHA_AZUL, K_FICHA_BRANCA,
            K_ECHO, K_ELETRO, K_LAB, K_RX, K_TOMO, K_USG, 
            K_MED_EV, K_MED_IM, K_MED_SUBCUT, K_MED_VO, K_MED_OFTAL, K_MED_INAL
        ];
        // -----------------------------------------------------------


        /**
         * @description Carrega os dados do Firebase Firestore. (NOVA FUNÇÃO)
         */
async function initDashboard() {
    document.getElementById('loadingMessage').style.display = 'block';

    try {
        // 1. Consulta todos os documentos da coleção no Firestore
        const snapshot = await db.collection(PRODUTIVIDADE_COLLECTION).get();
        
        // 2. Mapeia os documentos para o array allData
        allData = snapshot.docs.map(doc => {
            let data = doc.data();
            const newRow = {};
            
            // Função auxiliar para pegar o valor do Firebase e formatar
            const safeGet = (fieldName, isNumber = false) => {
                let value = data[fieldName];
                
                // --- TRATAMENTO DE DATA (Baseado no nome exato do CSV) ---
                if (fieldName === "Data do plantão:  ") {
                    // Se for Timestamp do Firebase
                    if (value && typeof value.toDate === 'function') {
                        return value.toDate().toISOString().substring(0, 10);
                    }
                    // Se for string brasileira DD/MM/AAAA
                    if (typeof value === 'string' && value.includes('/')) {
                        const partes = value.split('/');
                        if (partes.length === 3) {
                            return `${partes[2]}-${partes[1].padStart(2, '0')}-${partes[0].padStart(2, '0')}`;
                        }
                    }
                    // Se for string AAAA-MM-DD
                    if (typeof value === 'string' && value.includes('-')) {
                        return value.substring(0, 10);
                    }
                }

                if (isNumber) {
                    return (Number(value) || 0); 
                }
                
                return (value !== undefined && value !== null) ? String(value).trim() : '';
            };

            // Mapeando TODAS as colunas baseadas no seu arquivo CSV real
            // Nota: Os nomes abaixo agora conferem com "Produtividade.csv"
            newRow[K_DATA] = safeGet("Data do plantão:  ");
            newRow[K_TURNO] = safeGet("Diurno ou noturno:");
            newRow[K_DIA_SEMANA] = safeGet("Dia da semana:");
            newRow[K_MEDICO] = safeGet("Nome do médico ");

            // CHAVES DE PRODUTIVIDADE
            newRow[K_ATEND_NOVO] = safeGet("Número de Novos atendimentos:", true); 
            newRow[K_REAVALIACOES] = safeGet("Número Reavalições", true);
            newRow[K_TOTAL_GERAL] = newRow[K_ATEND_NOVO] + newRow[K_REAVALIACOES]; 

            // CHAVES DE FICHAS DE RISCO
            newRow[K_FICHA_VERDE] = safeGet("Número de fichas verdes", true);
            newRow[K_FICHA_AMARELA] = safeGet("Número de fichas amarelas", true);
            newRow[K_FICHA_LARANJA] = safeGet("Número de fichas laranja", true);
            newRow[K_FICHA_AZUL] = safeGet("Número de fichas azul", true);
            newRow[K_FICHA_BRANCA] = safeGet("Número de fichas brancas", true);

            // CHAVES DE EXAMES
            newRow[K_ECHO] = safeGet("Número de ecocardiograma", true);
            newRow[K_ELETRO] = safeGet("Número de eletrocardiograma", true);
            newRow[K_LAB] = safeGet("Número de laboratoriais", true);
            newRow[K_RX] = safeGet("Número de RX", true);
            newRow[K_TOMO] = safeGet("Tomografias", true);
            newRow[K_USG] = safeGet("USG", true);

            // CHAVES DE MEDICAÇÕES
            newRow[K_MED_EV] = safeGet("Medicação prescritas EV", true);
            newRow[K_MED_IM] = safeGet("Medicação prescritas IM", true);
            newRow[K_MED_SUBCUT] = safeGet("Medicação Subcultanea", true); 
            newRow[K_MED_VO] = safeGet("Medicação VO ou Subligual", true); 
            newRow[K_MED_INAL] = safeGet("INALATORIA", true);
            newRow[K_MED_OFTAL] = safeGet("OFTALMICA", true);
            
            return newRow;
        })
        .filter(row => row[K_MEDICO] !== ''); 

        // 3. Verifica e Renderiza
        if (allData.length > 0) {
            // Como seu CSV não tem 'Cliente' e 'Unidade', vamos popular apenas o que existe
            if (typeof populateMedicoFilter === 'function') populateMedicoFilter(allData);
            if (typeof populateTurnoFilter === 'function') populateTurnoFilter(allData); 
            
            updateDashboard();

            document.getElementById('applyFiltersBtn').onclick = updateDashboard;
            document.getElementById('clearFiltersBtn').onclick = clearFilters;
            
            // Habilita os controles que existem no seu HTML
            const controls = ['applyFiltersBtn', 'clearFiltersBtn', 'filtroData', 'filtroTurno', 'filtroMedico'];
            controls.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.disabled = false;
            });

        } else {
            document.getElementById('data-source-label').innerHTML = `AVISO: <span style="color:orange;">Nenhum dado encontrado no Firestore.</span>`;
            renderDetailedTable([]); 
        }
    } catch (error) {
        console.error("Erro ao carregar dados do Firebase:", error);
        document.getElementById('data-source-label').innerHTML = `ERRO CRÍTICO: <span style="color:red;">Falha na conexão com o Firebase.</span>`;
    } finally {
        document.getElementById('loadingMessage').style.display = 'none';
    }
}
        
        // --- FUNÇÕES DE DASHBOARD (COMPLETAS, IDÊNTICAS AO SEU CÓDIGO) ---

        // Funções de População de Filtros (Mantidas)
        function populateClienteFilter(data) { 
            const clientesValidos = data
                .map(item => item[K_CLIENTE] ? String(item[K_CLIENTE]).trim().toUpperCase() : null)
                .filter(cliente => cliente && cliente !== ''); 
            const clientes = [...new Set(clientesValidos)].sort();
            const select = document.getElementById('filtroCliente');
            select.innerHTML = '<option value="todos">Todos os Clientes</option>'; 
            clientes.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente;
                option.textContent = cliente;
                select.appendChild(option);
            });
            select.disabled = false;
        }

        function populateUnidadeFilter(data) { 
            const unidadesValidas = data
                .map(item => item[K_UNIDADE] ? String(item[K_UNIDADE]).trim().toUpperCase() : null)
                .filter(unidade => unidade && unidade !== ''); 
            const unidades = [...new Set(unidadesValidas)].sort();
            const select = document.getElementById('filtroUnidade');
            select.innerHTML = '<option value="todos">Todas as Unidades</option>'; 
            unidades.forEach(unidade => {
                const option = document.createElement('option');
                option.value = unidade;
                option.textContent = unidade;
                select.appendChild(option);
            });
            select.disabled = false;
        }

        function populateMedicoFilter(data) {
            
            const nomesValidos = data
                .map(item => item[K_MEDICO] ? String(item[K_MEDICO]).trim().toUpperCase() : null)
                .filter(nome => nome && nome !== ''); 

            const medicos = [...new Set(nomesValidos)].sort();

            const select = document.getElementById('filtroMedico');
            select.innerHTML = ''; 
            
            medicos.forEach(medico => {
                const option = document.createElement('option');
                option.value = medico;
                option.textContent = medico;
                select.appendChild(option);
            });
            
            select.disabled = false;
        }

        function populateTurnoFilter(data) {
            const turnosValidos = data
                .map(item => item[K_TURNO] ? String(item[K_TURNO]).trim().toUpperCase() : null)
                .filter(turno => turno && turno !== ''); 

            const turnos = [...new Set(turnosValidos)].sort();

            const select = document.getElementById('filtroTurno');
            select.innerHTML = '<option value="todos">Todos os Turnos</option>'; 
            
            turnos.forEach(turno => {
                const option = document.createElement('option');
                option.value = turno;
                option.textContent = turno;
                select.appendChild(option);
            });
            
            select.disabled = false;
        }

        // Função de Filtragem de Dados (Mantida)
        function filterData(data) {
            
            const selectMedicoElement = document.getElementById('filtroMedico');
            const selectedMedicos = Array.from(selectMedicoElement.selectedOptions)
                                        .map(option => option.value.toUpperCase());
            
            const filtroData = document.getElementById('filtroData').value;
            const filtroTurno = document.getElementById('filtroTurno').value; 
            const filtroCliente = document.getElementById('filtroCliente').value; 
            const filtroUnidade = document.getElementById('filtroUnidade').value; 
            
            let filteredData = data.filter(row => {
                const medicoNome = row[K_MEDICO] ? String(row[K_MEDICO]).trim().toUpperCase() : '';
                
                if (selectedMedicos.length === 0) {
                    return true;
                }
                return selectedMedicos.includes(medicoNome);
            });

            // Filtro Cliente
            filteredData = filteredData.filter(row => {
                const clienteNome = row[K_CLIENTE] ? String(row[K_CLIENTE]).trim().toUpperCase() : '';
                return filtroCliente === 'todos' || clienteNome === filtroCliente.toUpperCase();
            });
            
            // Filtro Unidade
            filteredData = filteredData.filter(row => {
                const unidadeNome = row[K_UNIDADE] ? String(row[K_UNIDADE]).trim().toUpperCase() : '';
                return filtroUnidade === 'todos' || unidadeNome === filtroUnidade.toUpperCase();
            });

            // Filtro Turno
            filteredData = filteredData.filter(row => {
                const turnoNome = row[K_TURNO] ? String(row[K_TURNO]).trim().toUpperCase() : '';
                return filtroTurno === 'todos' || turnoNome === filtroTurno.toUpperCase();
            });

            if (!filtroData) {
                return filteredData;
            }

            // Filtro Data (A PARTIR DE) - K_DATA já está no formato YYYY-MM-DD
            return filteredData.filter(row => {
                const rowDate = String(row[K_DATA] || '').substring(0, 10);
                return rowDate >= filtroData;
            });
        }
        
        // Funções de Geração de KPIs (Mantidas)
        function getFichasData(data) {
            const fichaCols = [K_FICHA_VERDE, K_FICHA_AMARELA, K_FICHA_LARANJA, K_FICHA_AZUL, K_FICHA_BRANCA];
            const labels = ['Verde', 'Amarela', 'Laranja', 'Azul', 'Branca'];
            const dataValues = fichaCols.map(col => 
                data.reduce((sum, row) => sum + (row[col] || 0), 0)
            );
            
            const combined = labels.map((label, index) => ({ label, data: dataValues[index] }))
                                   .sort((a, b) => b.data - a.data);
                                   
            return { 
                labels: combined.map(item => item.label), 
                data: combined.map(item => item.data) 
            };
        }

        function generateKPIs(data) {
            const selectElement = document.getElementById('filtroMedico');
            const selectedMedicos = Array.from(selectElement.selectedOptions).map(option => option.value);

            const totalAtendimentosOriginal = data.reduce((sum, row) => sum + (row[K_ATEND_TOTAL] || 0), 0);
            document.getElementById('totalAtendimentos').textContent = totalAtendimentosOriginal.toLocaleString('pt-BR');
            
            const novosAtendimentos = data.reduce((sum, row) => sum + (row[K_ATEND_NOVO] || 0), 0);
            document.getElementById('totalAtendimentosMedico').textContent = novosAtendimentos.toLocaleString('pt-BR');
            
            const tituloKPI = document.querySelector('#kpi-atendimento-medico h5');
            
            if (selectedMedicos.length === 1) {
                const primeiroNome = selectedMedicos[0].split(' ')[0];
                tituloKPI.textContent = `Novos Atend. de ${primeiroNome}`;
            } else if (selectedMedicos.length > 1) {
                 tituloKPI.textContent = `Novos Atend. (Grupo Selecionado)`;
            } else {
                tituloKPI.textContent = 'Novos Atendimentos';
            }
            
            const totalReavaliacoes = data.reduce((sum, row) => sum + (row[K_REAVALIACOES] || 0), 0);
            document.getElementById('totalEV').textContent = totalReavaliacoes.toLocaleString('pt-BR');
            
            const totalGeralCompleto = data.reduce((sum, row) => sum + (row[K_TOTAL_GERAL] || 0), 0);
            document.getElementById('totalEcocardiogramas').textContent = totalGeralCompleto.toLocaleString('pt-BR');
            
            const atendimentosPorTurno = data.reduce((acc, row) => {
                const turno = String(row[K_TURNO] || '').trim().toUpperCase();
                const novos = row[K_ATEND_NOVO] || 0;
                
                if (turno === 'DIURNO') {
                    acc.diurno += novos;
                } else if (turno === 'INTERMEDIARIO') {
                    acc.intermediario += novos;
                } else if (turno === 'NOTURNO') {
                    acc.noturno += novos;
                }
                
                return acc;
            }, { diurno: 0, intermediario: 0, noturno: 0 });

            document.getElementById('kpiDiurno').textContent = atendimentosPorTurno.diurno.toLocaleString('pt-BR');
            document.getElementById('kpiIntermediario').textContent = atendimentosPorTurno.intermediario.toLocaleString('pt-BR');
            document.getElementById('kpiNoturno').textContent = atendimentosPorTurno.noturno.toLocaleString('pt-BR');
        }

        // Funções de Dados para Gráficos (Mantidas)
        function getProdutividadePorMedicoData(data) {
            const agrupado = data.reduce((acc, row) => { 
                const medico = String(row[K_MEDICO]).trim();
                acc[medico] = (acc[medico] || 0) + (row[K_ATEND_TOTAL] || 0); 
                return acc;
            }, {});
            const sortedEntries = Object.entries(agrupado).sort(([, a], [, b]) => b - a);
            return {
                labels: sortedEntries.map(([medico]) => medico),
                data: sortedEntries.map(([, total]) => total)
            };
        }

        function getExamesPorMedicoData(data) {
            const exameCols = [K_ECHO, K_ELETRO, K_LAB, K_RX, K_TOMO, K_USG];
            const labels = ['Ecocardiograma', 'Eletrocardiograma', 'Laboratoriais', 'RX', 'Tomografias', 'USG'];
            const medicos = [...new Set(data.map(item => String(item[K_MEDICO]).trim()))].sort();
            
            const datasets = labels.map((label, index) => {
                const colName = exameCols[index];
                const backgroundColors = [colors.primario, colors.secundario, colors.amarelo, colors.vermelho, colors.roxo, colors.ciano];
                
                const dataValues = medicos.map(medico => 
                    data.filter(row => String(row[K_MEDICO]).trim() === medico)
                        .reduce((sum, row) => sum + (row[colName] || 0), 0)
                );
                
                return {
                    label: label,
                    data: dataValues,
                    backgroundColor: backgroundColors[index % backgroundColors.length],
                };
            });
            return {
                labels: medicos,
                datasets: datasets
            };
        }

        function getMedicacoesPorMedicoData(data) {
            const medCols = [K_MED_EV, K_MED_IM, K_MED_SUBCUT, K_MED_VO, K_MED_OFTAL, K_MED_INAL];
            const agrupado = data.reduce((acc, row) => {
                const medico = String(row[K_MEDICO]).trim();
                const totalMeds = medCols.reduce((sum, col) => sum + (row[col] || 0), 0);
                acc[medico] = (acc[medico] || 0) + totalMeds;
                return acc;
            }, {});
            const sortedEntries = Object.entries(agrupado).sort(([, a], [, b]) => b - a);
            return {
                labels: sortedEntries.map(([medico]) => medico),
                data: sortedEntries.map(([, total]) => total)
            };
        }
        
        function getAtendimentosDiaSemanaData(data) {
            const ordemDias = ['SEGUNDA-FEIRA', 'TERÇA-FEIRA', 'QUARTA-FEIRA', 'QUINTA-FEIRA', 'SEXTA-FEIRA', 'SÁBADO', 'DOMINGO'];
            const agrupado = data.reduce((acc, row) => {
                const dia = row[K_DIA_SEMANA] ? String(row[K_DIA_SEMANA]).toUpperCase().trim() : 'N/A';
                acc[dia] = (acc[dia] || 0) + (row[K_ATEND_TOTAL] || 0);
                return acc;
            }, {});
            const labels = ordemDias.filter(dia => agrupado[dia] !== undefined);
            const dataValues = labels.map(dia => agrupado[dia] || 0);
            return { labels, data: dataValues };
        }

        function getMedicacoesData(data) {
            const medCols = [K_MED_EV, K_MED_IM, K_MED_SUBCUT, K_MED_VO, K_MED_OFTAL, K_MED_INAL];
            const labels = ['EV', 'IM', 'Subcutânea', 'VO/Sublingual', 'Oftálmica', 'Inalação'];
            const dataValues = medCols.map(col => 
                data.reduce((sum, row) => sum + (row[col] || 0), 0)
            );
            
            const combined = labels.map((label, index) => ({ label, data: dataValues[index] }))
                                   .sort((a, b) => b.data - a.data);
                                   
            return { 
                labels: combined.map(item => item.label), 
                data: combined.map(item => item.data) 
            };
        }

        // Função de Criação de Gráficos (Mantida)
        function createCharts(data) {
            if (examesPorMedicoChartInstance) examesPorMedicoChartInstance.destroy();
            if (medicacoesPorMedicoChartInstance) medicacoesPorMedicoChartInstance.destroy();
            if (produtividadePorMedicoChartInstance) produtividadePorMedicoChartInstance.destroy();
            if (atendimentosDiaSemanaChartInstance) atendimentosDiaSemanaChartInstance.destroy();
            if (medicacoesChartInstance) medicacoesChartInstance.destroy();
            if (fichasClassificacaoChartInstance) fichasClassificacaoChartInstance.destroy(); 

            // 1. Produtividade por Médico
            const produtividade = getProdutividadePorMedicoData(data);
            if (produtividade.data.length > 0) {
                produtividadePorMedicoChartInstance = new Chart(document.getElementById('produtividadePorMedicoChart'), {
                    type: 'bar',
                    data: {
                        labels: produtividade.labels,
                        datasets: [{
                            label: 'Total de Atendimentos',
                            data: produtividade.data,
                            backgroundColor: colors.primario,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y', 
                        scales: { x: { beginAtZero: true } },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // 2. Atendimentos por Dia da Semana
            const atendimentosDiaSemana = getAtendimentosDiaSemanaData(data);
            if (atendimentosDiaSemana.data.length > 0) {
                atendimentosDiaSemanaChartInstance = new Chart(document.getElementById('atendimentosDiaSemanaChart'), {
                    type: 'bar',
                    data: {
                        labels: atendimentosDiaSemana.labels,
                        datasets: [{
                            label: 'Total de Atendimentos',
                            data: atendimentosDiaSemana.data,
                            backgroundColor: colors.secundario,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true } },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // 3. Exames Solicitados por Médico (Gráfico Empilhado)
            const examesData = getExamesPorMedicoData(data);
            if (examesData.labels.length > 0) {
                examesPorMedicoChartInstance = new Chart(document.getElementById('examesPorMedicoChart'), {
                    type: 'bar',
                    data: examesData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { stacked: true, beginAtZero: true },
                            y: { stacked: true, beginAtZero: true }
                        },
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            }
            
            // 4. Medicações Prescritas por Médico (Total)
            const medicacoesPorMedico = getMedicacoesPorMedicoData(data);
            if (medicacoesPorMedico.data.length > 0) {
                 medicacoesPorMedicoChartInstance = new Chart(document.getElementById('medicacoesPorMedicoChart'), {
                    type: 'bar',
                    data: {
                        labels: medicacoesPorMedico.labels,
                        datasets: [{
                            label: 'Total de Medicações Prescritas',
                            data: medicacoesPorMedico.data,
                            backgroundColor: colors.vermelho,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y', 
                        scales: { x: { beginAtZero: true } },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // 5. GRÁFICO: Fichas de Classificação de Risco
            const fichasData = getFichasData(data);
            if (fichasData.data.length > 0) {
                const colorsMap = {
                    'Verde': colors.secundario, 
                    'Amarela': colors.amarelo, 
                    'Laranja': colors.laranja, 
                    'Azul': colors.primario, 
                    'Branca': colors.cinza
                };
                
                const backgroundColors = fichasData.labels.map(label => colorsMap[label] || colors.cinza);

                fichasClassificacaoChartInstance = new Chart(document.getElementById('fichasClassificacaoChart'), {
                    type: 'bar',
                    data: {
                        labels: fichasData.labels,
                        datasets: [{
                            label: 'Total de Fichas',
                            data: fichasData.data,
                            backgroundColor: backgroundColors,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y', 
                        scales: { x: { beginAtZero: true } },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // 6. Medicações Prescritas (Total Geral)
            const medicacoes = getMedicacoesData(data);
            if (medicacoes.data.length > 0) {
                medicacoesChartInstance = new Chart(document.getElementById('medicacoesChart'), {
                    type: 'bar',
                    data: {
                        labels: medicacoes.labels,
                        datasets: [{
                            label: 'Total de Prescrições',
                            data: medicacoes.data,
                            backgroundColor: colors.amarelo,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y', 
                        scales: { x: { beginAtZero: true } },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        }

        // Funções de Alerta e Limpeza (Mantidas)
        function toggleFilterAlert(show) {
            const alertDiv = document.getElementById('filterAlert');
            if (show) {
                alertDiv.style.display = 'block';
                setTimeout(() => {
                    alertDiv.style.display = 'none';
                }, 8000); 
            } else {
                alertDiv.style.display = 'none';
            }
        }
        
        function clearFilters() {
            Array.from(document.getElementById('filtroMedico').options).forEach(option => {
                option.selected = false;
            });
            
            document.getElementById('filtroCliente').value = 'todos'; 
            document.getElementById('filtroUnidade').value = 'todos'; 
            document.getElementById('filtroData').value = '';
            document.getElementById('filtroTurno').value = 'todos'; 
            
            updateDashboard();
        }

        // Função de Renderização da Tabela Detalhada (Mantida)
        function renderDetailedTable(data) {
            const container = document.getElementById('detailedTableContainer');
            
            const selectedMedicos = Array.from(document.getElementById('filtroMedico').selectedOptions).map(option => option.value);
            const filtroTurno = document.getElementById('filtroTurno').value;
            const filtroCliente = document.getElementById('filtroCliente').value;
            const filtroUnidade = document.getElementById('filtroUnidade').value;
            
            let titleText = `Detalhes dos Registros`;
            
            let filterDetails = [];
            if (filtroCliente !== 'todos') filterDetails.push(`Cliente: ${filtroCliente}`);
            if (filtroUnidade !== 'todos') filterDetails.push(`Unidade: ${filtroUnidade}`);
            if (selectedMedicos.length > 0) {
                filterDetails.push(selectedMedicos.length === 1 ? `Médico: ${selectedMedicos[0]}` : `${selectedMedicos.length} Médicos`);
            }
            if (filtroTurno !== 'todos') filterDetails.push(`Turno: ${filtroTurno}`);
            
            if (filterDetails.length > 0) {
                titleText += ` (${filterDetails.join(', ')})`;
            }

            document.getElementById('detailed-data-title').textContent = titleText;


            if (data.length === 0) {
                container.innerHTML = '<p class="text-center text-muted p-4 mb-0">Nenhum registro encontrado com os filtros aplicados.</p>';
                return;
            }

            let tableHTML = `<table class="table table-striped table-hover table-sm">`;
            
            // 1. Cabeçalho (Header)
            tableHTML += `<thead><tr>`;
            COLUMN_ORDER.forEach(key => {
                tableHTML += `<th scope="col" title="${DISPLAY_COLUMNS[key]}">${DISPLAY_COLUMNS[key].replace(/\s\(.*\)/, '')}</th>`;
            });
            tableHTML += `</tr></thead>`;

            // 2. Corpo da Tabela (Body)
            tableHTML += `<tbody>`;
            data.forEach(row => {
                tableHTML += `<tr>`;
                COLUMN_ORDER.forEach(key => {
                    let value = row[key];
                    let alignment = 'text-start'; 

                    const isNonNumericColumn = [K_DATA, K_CLIENTE, K_UNIDADE, K_MEDICO, K_TURNO, K_DIA_SEMANA].includes(key); 

                    if (!isNaN(value) && value !== null && value !== '' && !isNonNumericColumn) {
                        value = Number(value).toLocaleString('pt-BR');
                        alignment = 'text-center'; 
                    } else if (key === K_DATA && value) {
                        // Formata a data (assumindo YYYY-MM-DD do safeGet) para DD/MM/YYYY
                        const dateParts = String(value).substring(0, 10).split('-');
                        if (dateParts.length === 3) {
                            value = `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
                        }
                    } else if (isNonNumericColumn) {
                        alignment = 'text-start'; 
                    }
                    
                    tableHTML += `<td class="${alignment}">${value || '-'}</td>`;
                });
                tableHTML += `</tr>`;
            });
            tableHTML += `</tbody>`;
            
            tableHTML += `</table>`;
            
            container.innerHTML = tableHTML;
        }

        // Função de Atualização do Dashboard (Mantida)
        function updateDashboard() {
            const filteredData = filterData(allData);

            if (filteredData.length === 0) {
                toggleFilterAlert(true);
                generateKPIs([]); 
                createCharts([]);
                renderDetailedTable([]); 
            } else {
                toggleFilterAlert(false);
                generateKPIs(filteredData);
                createCharts(filteredData);
                renderDetailedTable(filteredData); 
            }
        }

        initDashboard();

    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>