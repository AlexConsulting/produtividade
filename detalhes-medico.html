<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rio Individual Detalhado</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
        body { background-color: #f8f9fa; padding: 20px; }
        .kpi-card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 5px solid #007bff; height: 100%; }
        .chart-box { background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); min-height: 350px; }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4 no-print">
            <button class="btn btn-secondary" onclick="window.close()">Fechar</button>
            <button class="btn btn-danger" onclick="window.print()">üñ®Ô∏è Imprimir PDF</button>
        </div>

        <div id="relatorioConteudo">
            <h2 id="tituloMedico" class="text-center mb-4 text-primary">Carregando...</h2>
            
            <div class="row mb-4 g-3">
                <div class="col-md-3"><div class="kpi-card text-center"><small>TOTAL ATENDIMENTOS</small><div id="totalAtend" class="h2 mb-0 fw-bold">0</div></div></div>
                <div class="col-md-3"><div class="kpi-card text-center" style="border-left-color: #28a745;"><small>M√âDIA POR PLANT√ÉO</small><div id="mediaAtend" class="h2 mb-0 fw-bold">0</div></div></div>
                <div class="col-md-3"><div class="kpi-card text-center" style="border-left-color: #17a2b8;"><small>TOTAL PLANT√ïES</small><div id="totalPlantoes" class="h2 mb-0 fw-bold">0</div></div></div>
                <div class="col-md-3"><div class="kpi-card text-center" style="border-left-color: #dc3545;"><small>TOTAL REAVALIA√á√ïES</small><div id="totalReav" class="h2 mb-0 fw-bold">0</div></div></div>
            </div>

            <div class="row">
                <div class="col-md-8"><div class="chart-box"><h6>Produ√ß√£o Di√°ria</h6><canvas id="chartLinha"></canvas></div></div>
                <div class="col-md-4"><div class="chart-box"><h6>Classifica√ß√£o de Risco</h6><canvas id="chartFichas"></canvas></div></div>
            </div>

            <div class="row">
                <div class="col-md-6"><div class="chart-box"><h6>Exames Solicitados</h6><canvas id="chartExames"></canvas></div></div>
                <div class="col-md-6"><div class="chart-box"><h6>Medica√ß√µes por Via</h6><canvas id="chartMedS"></canvas></div></div>
            </div>

            <div class="bg-white p-3 rounded shadow-sm">
                <table class="table table-sm table-bordered mt-3">
                    <thead class="table-dark">
                        <tr><th>Data</th><th>Turno</th><th>Cliente</th><th>Unidade</th><th>Novos</th><th>Reav.</th><th>Total</th></tr>
                    </thead>
                    <tbody id="tabelaCorpo"></tbody>
                </table>
            </div>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyA_22plUsZfyzW909W1ePkCJxq-KdUydcw",
        authDomain: "produtividade-4d98e.firebaseapp.com",
        projectId: "produtividade-4d98e",
        storageBucket: "produtividade-4d98e.firebasestorage.app",
        messagingSenderId: "642824868640",
        appId: "1:642824868640:web:3e6ea0e09c41ec09023d45",
        measurementId: "G-489RSTNQVT"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const PRODUTIVIDADE_COLLECTION = 'produtividade'; 

    async function carregarRelatorio() {
        console.log("--- INICIANDO BUSCA ULTRA-RESISTENTE ---");
        const urlParams = new URLSearchParams(window.location.search);
        let nomeUrl = urlParams.get('medico') || urlParams.get('nome');

        if (!nomeUrl) {
            document.getElementById('tituloMedico').innerText = "Erro: M√©dico n√£o selecionado.";
            return;
        }

        const nomeBuscado = decodeURIComponent(nomeUrl).trim().toUpperCase();
        document.getElementById('tituloMedico').innerText = `RELAT√ìRIO: ${nomeBuscado}`;

        try {
            // Pegamos todos os dados (Filtro local evita erros de nomes de colunas do Firebase)
            const snapshot = await db.collection(PRODUTIVIDADE_COLLECTION).get();
            
            console.log("Total de documentos no banco:", snapshot.size);

            const docsFiltrados = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                // Procuramos em TODOS os campos do documento se existe o nome do m√©dico
                const encontrou = Object.values(data).some(valor => 
                    valor && valor.toString().trim().toUpperCase() === nomeBuscado
                );

                if (encontrou) docsFiltrados.push(data);
            });

            if (docsFiltrados.length === 0) {
                console.error("Nenhum dado encontrado para:", nomeBuscado);
                document.getElementById('tituloMedico').innerText = `Nenhum registro para: ${nomeBuscado}`;
                // Log do conte√∫do de um documento para voc√™ ver o que h√° dentro
                if(snapshot.size > 0) console.log("Dados de exemplo no banco:", snapshot.docs[0].data());
                return;
            }

            console.log(`Sucesso: ${docsFiltrados.length} registros encontrados.`);
            processarDados(docsFiltrados);

        } catch (error) {
            console.error("Erro ao acessar Firebase:", error);
            document.getElementById('tituloMedico').innerText = "Erro de conex√£o.";
        }
    }

    function processarDados(listaDados) {
        let totalAtend = 0;
        let totalReav = 0;
        const f = { Verde: 0, Amarela: 0, Laranja: 0, Azul: 0, Branca: 0 };
        const e = { Lab: 0, RX: 0, Tomo: 0, USG: 0 };
        const m = { EV: 0, IM: 0, VO: 0, Inal: 0 };
        const daily = {};

        const tbody = document.getElementById('tabelaCorpo');
        tbody.innerHTML = "";

        listaDados.forEach(d => {
            // Mapeamento de chaves (ajustado para os nomes com ':' e espa√ßos)
            const n = Number(d['N√∫mero de Novos atendimentos:']) || 0;
            const r = Number(d['N√∫mero Reavali√ß√µes']) || 0;
            const dt = d['Data do plant√£o:  '] || d['Data do plant√£o:'] || 'S/D';

            totalAtend += (n + r);
            totalReav += r;
            
            // Gr√°fico di√°rio
            daily[dt] = (daily[dt] || 0) + (n + r);

            // Somat√≥rios das Classifica√ß√µes
            f.Verde += Number(d['N√∫mero de fichas verdes']) || 0;
            f.Amarela += Number(d['N√∫mero de fichas amarelas']) || 0;
            f.Laranja += Number(d['N√∫mero de fichas laranja']) || 0;
            f.Azul += Number(d['N√∫mero de fichas azul']) || 0;
            f.Branca += Number(d['N√∫mero de fichas brancas']) || 0;

            // Somat√≥rios de Exames
            e.Lab += Number(d['N√∫mero de laboratoriais']) || 0;
            e.RX += Number(d['N√∫mero de RX']) || 0;
            e.Tomo += Number(d['Tomografias']) || 0;
            e.USG += Number(d['USG']) || 0;

            // Somat√≥rios de Medica√ß√µes
            m.EV += Number(d['Medica√ß√£o prescritas EV']) || 0;
            m.IM += Number(d['Medica√ß√£o prescritas IM']) || 0;
            m.VO += Number(d['Medica√ß√£o VO ou Subligual']) || 0;
            m.Inal += Number(d['INALATORIA']) || 0;

            tbody.innerHTML += `<tr>
                <td>${dt}</td>
                <td>${d['Diurno ou noturno:'] || '-'}</td>
                <td>${d['Cliente'] || '-'}</td>
                <td>${d['Unidade'] || '-'}</td>
                <td class="text-center">${n}</td>
                <td class="text-center">${r}</td>
                <td class="text-center fw-bold">${n+r}</td>
            </tr>`;
        });

        // Atualizar KPIs
        document.getElementById('totalAtend').innerText = totalAtend;
        document.getElementById('totalReav').innerText = totalReav;
        document.getElementById('totalPlantoes').innerText = listaDados.length;
        document.getElementById('mediaAtend').innerText = (totalAtend / listaDados.length).toFixed(1);

        renderizarGraficos(daily, f, e, m);
    }

    function renderizarGraficos(daily, f, e, m) {
        // Linha: Produ√ß√£o
        new Chart(document.getElementById('chartLinha'), {
            type: 'line',
            data: { labels: Object.keys(daily).sort(), datasets: [{ label: 'Atendimentos', data: Object.values(daily), borderColor: '#007bff', fill: true, tension: 0.3 }] }
        });

        // Rosca: Fichas
        new Chart(document.getElementById('chartFichas'), {
            type: 'doughnut',
            data: { labels: Object.keys(f), datasets: [{ data: Object.values(f), backgroundColor: ['#28a745', '#ffc107', '#fd7e14', '#007bff', '#6c757d'] }] }
        });

        // Barras: Exames
        new Chart(document.getElementById('chartExames'), {
            type: 'bar',
            data: { labels: ['Lab', 'RX', 'Tomo', 'USG'], datasets: [{ label: 'Qtd', data: [e.Lab, e.RX, e.Tomo, e.USG], backgroundColor: '#17a2b8' }] }
        });

        // Barras: Meds
        new Chart(document.getElementById('chartMedS'), {
            type: 'bar',
            data: { labels: ['EV', 'IM', 'VO', 'Inal'], datasets: [{ label: 'Vias', data: [m.EV, m.IM, m.VO, m.Inal], backgroundColor: '#dc3545' }] }
        });
    }

    window.onload = carregarRelatorio;
</script>
</body>
</html>