<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Produtividade Clínica</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script> 
    <style>
        body { background-color: #f8f9fa; }
        .dashboard-header { background-color: #007bff; color: white; padding: 20px 0; margin-bottom: 30px; }
        
        /* --- ESTILO KPI CARD --- */
        .kpi-card { 
            border-left: 5px solid #007bff; 
            border-radius: .5rem; 
            transition: transform 0.2s, box-shadow 0.2s;
            background-color: white; 
            box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,.05);
            min-height: 120px;
            display: flex; 
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .kpi-card:hover { transform: translateY(-3px); box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15); }
        
        .kpi-card h5 {
            word-wrap: break-word; 
            text-align: center;
            font-size: 0.9rem; 
            min-height: 40px; 
            margin-bottom: 0.25rem;
        }
        
        .kpi-card p { margin-top: 5px; }
        
        /* --- ESTILO GERAL --- */
        .chart-container { 
            background-color: white; 
            padding: 20px; 
            border-radius: .5rem; 
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15); 
            position: relative; 
        }
        .form-select, .form-control { border-radius: .3rem; }
        .alert-loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }
    </style>
</head>
<body>

    <header class="dashboard-header">
        <div class="container">
            <h1 class="text-center">Painel de Indicadores de Produtividade - M.Boi</h1>
        </div>
    </header>

    <main class="container">
        <div id="loadingMessage" class="alert alert-info alert-loading" role="alert" style="display:none;">
            Carregando dados do Banco de Dados SQLite...
        </div>
        
        <div id="filterAlert" class="alert alert-warning text-center" role="alert" style="display:none;">
            <strong>⚠️ Nenhum dado encontrado.</strong> O filtro de Data (A partir de) e/ou Médico não retornou registros.
        </div>
        
        <section id="filters" class="mb-4 p-4 chart-container">
            <h4 class="mb-3">Filtros de Visualização</h4>
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="filtroMedico" class="form-label fw-bold">1. Filtrar por Médico:</label>
                    <select class="form-select" id="filtroMedico" disabled>
                        <option value="todos">Carregando...</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="filtroData" class="form-label fw-bold">2. Filtrar por Data (A partir de):</label>
                    <input type="date" class="form-control" id="filtroData" disabled>
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-md-6">
                    <button class="btn btn-primary w-100" id="applyFiltersBtn" disabled>Aplicar Filtros</button>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-secondary w-100" id="clearFiltersBtn" disabled>Limpar Filtros</button>
                </div>
            </div>
            <div class="row g-3 mt-3">
                <div class="col-md-12">
                    <label for="dbFileName" class="form-label fw-bold" id="data-source-label">FONTE DE DADOS: SQLite Local (produtividade.db)</label>
                    <input class="form-control" type="text" id="dbFileName" value="produtividade.db" readonly style="color:#007bff;">
                </div>
            </div>

        </section>

        <section id="kpis" class="mb-5">
            <div class="row text-center">
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card kpi-card p-3 shadow-sm">
                        <h5 class="card-title text-muted">Total Geral de Atendimentos</h5>
                        <p class="card-text fs-3 fw-bold text-primary" id="totalAtendimentos">0</p>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card kpi-card p-3 shadow-sm" id="kpi-atendimento-medico">
                        <h5 class="card-title text-muted">Novos Atendimentos</h5>
                        <p class="card-text fs-3 fw-bold text-success" id="totalAtendimentosMedico">0</p>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card kpi-card p-3 shadow-sm">
                        <h5 class="card-title text-muted">Total de Reavaliações</h5>
                        <p class="card-text fs-3 fw-bold text-danger" id="totalEV">0</p>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card kpi-card p-3 shadow-sm">
                        <h5 class="card-title text-muted">Atend. + Reavaliações</h5>
                        <p class="card-text fs-3 fw-bold text-warning" id="totalEcocardiogramas">0</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="charts">
            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="chart-container" style="height: 400px;">
                        <h5 class="text-center mb-3">Produtividade por Médico (Atend. Totais)</h5>
                        <canvas id="produtividadePorMedicoChart"></canvas>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="chart-container" style="height: 400px;">
                        <h5 class="text-center mb-3">Atendimentos por Dia da Semana</h5>
                        <canvas id="atendimentosDiaSemanaChart"></canvas>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="chart-container" style="height: 400px;">
                        <h5 class="text-center mb-3">Exames Solicitados por Médico</h5>
                        <canvas id="examesPorMedicoChart"></canvas>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="chart-container" style="height: 400px;">
                        <h5 class="text-center mb-3">Medicações Prescritas por Médico</h5>
                        <canvas id="medicacoesPorMedicoChart"></canvas>
                    </div>
                </div>
                <div class="col-12 mb-4">
                    <div class="chart-container" style="height: 300px;">
                        <h5 class="text-center mb-3">Medicações Prescritas (Total Geral)</h5>
                        <canvas id="medicacoesChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

    </main>
    <footer class="text-center text-muted py-3">Dashboard de Produtividade - M.Boi</footer>

    <script>
        let allData = [];
        let examesPorMedicoChartInstance;
        let medicacoesPorMedicoChartInstance;
        let produtividadePorMedicoChartInstance;
        let atendimentosDiaSemanaChartInstance;
        let medicacoesChartInstance;

        const colors = {
            primario: 'rgba(0, 123, 255, 0.7)',
            secundario: 'rgba(40, 167, 69, 0.7)',
            amarelo: 'rgba(255, 193, 7, 0.7)',
            vermelho: 'rgba(220, 53, 69, 0.7)',
            roxo: 'rgba(108, 99, 255, 0.7)',
            ciano: 'rgba(23, 162, 184, 0.7)',
            cinza: 'rgba(108, 117, 125, 0.7)'
        };

        // --- DEFINIÇÃO DAS CHAVES INTERNAS (CHAVES LIMPAS PARA USO NO JS) ---
        const K_DATA = 'data';
        const K_MEDICO = 'medico'; 
        
        // CHAVES ORIGINAIS DO GRÁFICO (Mantidas para a lógica dos gráficos)
        const K_ATEND_TOTAL = 'atend_total'; // TOTAL DE ATENDIMENTO
        
        // NOVAS CHAVES DE KPI
        const K_ATEND_NOVO = 'atend_novo'; // NOVO ATENDIMENTO
        const K_REAVALIACOES = 'reavaliacoes'; // REAVALIAÇÕES
        const K_TOTAL_GERAL = 'total_geral_completo'; // TOTAL ATEND + REAVALIAÇÕES

        const K_ECHO = 'echo';
        const K_ELETRO = 'eletro';
        const K_LAB = 'lab';
        const K_RX = 'rx';
        const K_TOMO = 'tomo';
        const K_USG = 'usg';
        const K_MED_EV = 'med_ev';
        const K_MED_IM = 'med_im';
        const K_MED_SUBCUT = 'med_subcut';
        const K_MED_VO = 'med_vo';
        const K_MED_OFTAL = 'med_oftal';
        const K_MED_INAL = 'med_inal';
        const K_DIA_SEMANA = 'dia_semana';
        
        // --- CHAVES DE CORRESPONDÊNCIA PARA ENCONTRAR COLUNAS NO DB (Versão Simplificada) ---
        const COLUMN_MAP_KEYS = {
            [K_DATA]: 'Data do plantao',
            [K_MEDICO]: 'Nome do medico',
            
            // CHAVES ORIGINAIS DO GRÁFICO
            [K_ATEND_TOTAL]: 'Total de atendimento', 
            
            // NOVAS CHAVES DE KPI
            [K_ATEND_NOVO]: 'Numero de Novos atendimentos:', 
            [K_REAVALIACOES]: 'Numero Reavalicões', 
            [K_TOTAL_GERAL]: 'Total de atendimento novos atendimentos e reavalicões:',

            [K_ECHO]: 'ecocardiograma',
            [K_ELETRO]: 'eletrocardiograma',
            [K_LAB]: 'laboratoriais',
            [K_RX]: 'RX',
            [K_TOMO]: 'Tomografias',
            [K_USG]: 'USG',
            [K_MED_EV]: 'EV', // Medicacao prescritas EV
            [K_MED_IM]: 'IM', // Medicacao prescritas IM
            [K_MED_SUBCUT]: 'Subcultanea',
            [K_MED_VO]: 'VO ou Subligual',
            [K_MED_OFTAL]: 'OFTALMICA',
            [K_MED_INAL]: 'ILAcaO',
            [K_DIA_SEMANA]: 'Dia da sema'
        };

        // 2. FUNÇÃO PARA LER OS DADOS DO ARQUIVO SQLITE USANDO SQL.JS
        async function loadDataFromSQLite() {
            document.getElementById('loadingMessage').style.display = 'block';
            
            const DB_FILE = 'produtividade.db'; 
            
            try {
                // Inicializa o SQL.js
                const SQL = await initSqlJs({ 
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}` 
                });
                
                // Carrega o arquivo binário do .db
                const response = await fetch(DB_FILE);
                if (!response.ok) {
                    throw new Error(`Não foi possível carregar o arquivo DB: ${DB_FILE}. Verifique se ele está no mesmo local que o HTML. Status: ${response.status}`);
                }
                const buffer = await response.arrayBuffer();
                const db = new SQL.Database(new Uint8Array(buffer));
                
                // 1. DESCOBRIR O NOME DA TABELA REAL 
                const tableRes = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%'");
                if (tableRes.length === 0) {
                    throw new Error("Nenhuma tabela de dados encontrada no banco de dados.");
                }
                const tableName = tableRes[0].values[0][0]; 
                
                // 2. OBTER TODOS OS DADOS DA TABELA USANDO ASPAS DUPLAS NO SELECT *
                const res = db.exec(`SELECT * FROM "${tableName}"`);
                
                if (res.length === 0 || res[0].values.length === 0) {
                    db.close();
                    return [];
                }

                const columns = res[0].columns;
                const values = res[0].values;
                
                // 3. MAPEAR NOMES DE COLUNAS REAIS PARA CHAVES INTERNAS (K_*)
                const dbKeyToInternalKey = {}; 
                const internalKeys = Object.keys(COLUMN_MAP_KEYS);

                for (const dbColName of columns) {
                    const cleanDbColName = dbColName.toLowerCase().replace(/[\s\t:()-]/g, '');

                    for (const internalKey of internalKeys) {
                        const simpleMatchString = COLUMN_MAP_KEYS[internalKey].toLowerCase().replace(/[\s\t:()-]/g, '');
                        
                        if (cleanDbColName.includes(simpleMatchString) && !dbKeyToInternalKey[internalKey]) {
                            dbKeyToInternalKey[internalKey] = dbColName;
                            break; 
                        }
                    }
                }

                // 4. PROCESSAMENTO DOS DADOS USANDO O MAPA
                let processedData = values.map(rowValues => {
                    let row = {};
                    columns.forEach((col, index) => {
                        row[col] = rowValues[index];
                    });
                    
                    let newRow = {};
                    
                    const safeGet = (internalKey, isNumber = false) => {
                        const dbColName = dbKeyToInternalKey[internalKey];
                        const value = row[dbColName];
                        return isNumber ? (Number(value) || 0) : (value || '');
                    };

                    newRow[K_DATA] = safeGet(K_DATA);
                    newRow[K_MEDICO] = safeGet(K_MEDICO);
                    newRow[K_ATEND_TOTAL] = safeGet(K_ATEND_TOTAL, true);
                    
                    // --- NOVOS CAMPOS PARA KPI ---
                    newRow[K_ATEND_NOVO] = safeGet(K_ATEND_NOVO, true); 
                    newRow[K_REAVALIACOES] = safeGet(K_REAVALIACOES, true);
                    newRow[K_TOTAL_GERAL] = safeGet(K_TOTAL_GERAL, true); 
                    // ----------------------------
                    
                    newRow[K_ECHO] = safeGet(K_ECHO, true);
                    newRow[K_ELETRO] = safeGet(K_ELETRO, true);
                    newRow[K_LAB] = safeGet(K_LAB, true);
                    newRow[K_RX] = safeGet(K_RX, true);
                    newRow[K_TOMO] = safeGet(K_TOMO, true);
                    newRow[K_USG] = safeGet(K_USG, true);
                    
                    newRow[K_MED_EV] = safeGet(K_MED_EV, true);
                    newRow[K_MED_IM] = safeGet(K_MED_IM, true);
                    newRow[K_MED_SUBCUT] = safeGet(K_MED_SUBCUT, true); 
                    newRow[K_MED_VO] = safeGet(K_MED_VO, true); 
                    newRow[K_MED_OFTAL] = safeGet(K_MED_OFTAL, true);
                    newRow[K_MED_INAL] = safeGet(K_MED_INAL, true); 
                    
                    newRow[K_DIA_SEMANA] = safeGet(K_DIA_SEMANA);
                    
                    return newRow;
                })
                .filter(row => row[K_MEDICO] && String(row[K_MEDICO]).trim() !== ''); // Filtra linhas sem nome de médico

                document.getElementById('loadingMessage').style.display = 'none';
                db.close();
                return processedData;

            } catch (error) {
                document.getElementById('loadingMessage').style.display = 'none';
                console.error('Erro ao carregar ou processar o SQLite:', error);
                
                // --- MELHORIA: EXIBIR ERRO CRÍTICO NA INTERFACE ---
                let errorMessage = error.message;
                if (errorMessage.includes('Not Found') || errorMessage.includes('404')) {
                    errorMessage = `O arquivo "${DB_FILE}" não foi encontrado. Certifique-se de que ele está no mesmo local do arquivo HTML.`;
                } else if (errorMessage.includes('Nenhuma tabela')) {
                    errorMessage = `O DB foi encontrado, mas está vazio ou corrompido.`;
                }
                
                // Atualiza o elemento para o usuário ver o erro
                document.getElementById('data-source-label').innerHTML = `ERRO CRÍTICO: <span style="color:red;">${errorMessage}</span>`;
                document.getElementById('dbFileName').style.color = 'red';
                document.getElementById('totalAtendimentos').textContent = "ERRO";
                document.getElementById('totalAtendimentosMedico').textContent = "---";
                // ----------------------------------------------------

                console.error(`ERRO CRÍTICO: Não foi possível ler o SQLite. Detalhes: ${errorMessage}`);
                return [];
            }
        }
        
        // --- FUNÇÃO CORRIGIDA/COM DEBUG PARA FILTRAR OS DADOS (LÓGICA: >=) ---
        function filterData(data) {
            const filtroMedico = document.getElementById('filtroMedico').value;
            const filtroData = document.getElementById('filtroData').value; // Sempre AAAA-MM-DD
            
            // 1. Filtrar por médico
            const filteredByMedico = data.filter(row => {
                const medicoNome = row[K_MEDICO] ? String(row[K_MEDICO]).trim().toUpperCase() : '';
                return filtroMedico === 'todos' || medicoNome === filtroMedico.toUpperCase();
            });

            if (!filtroData) {
                return filteredByMedico;
            }

            // 2. Filtrar por data (LÓGICA: MAIOR OU IGUAL (>=) - A PARTIR DE)
            return filteredByMedico.filter(row => {
                
                // LIMPEZA AGRESSIVA: remove espaços, aspas simples, duplas e caracteres nulos
                let rawDate = String(row[K_DATA] || '').trim().replace(/['"\u0000]/g, ''); 
                let normalizedDate = null;
                
                if (!rawDate) {
                    return false;
                }

                // TENTA 1: Timestamp (número grande, ex: 1672531200000)
                if (!isNaN(rawDate) && rawDate.length > 10) {
                    const dateObj = new Date(parseInt(rawDate, 10));
                    normalizedDate = dateObj.toISOString().substring(0, 10); // AAAA-MM-DD
                }
                // TENTA 2: Formato Brasileiro (DD/MM/AAAA)
                else if (rawDate.includes('/') && rawDate.length >= 8) {
                    const parts = rawDate.substring(0, 10).split('/');
                    if (parts.length === 3 && parts[2].length === 4) {
                        // Converte para AAAA-MM-DD
                        normalizedDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                    }
                } 
                // TENTA 3: Formato ISO/DB (AAAA-MM-DD HH:MM:SS ou AAAA-MM-DD)
                else if (rawDate.includes('-') && rawDate.length >= 10) {
                    normalizedDate = rawDate.substring(0, 10); // AAAA-MM-DD
                }
                
                // ** A MUDANÇA: Comparação de strings YYYY-MM-DD com MAIOR OU IGUAL (>=) **
                const isDataMatch = normalizedDate >= filtroData;

                // LOG DE DEBUG
                // console.log(`[DEBUG DATE] TIPO DE FILTRO: MAIOR OU IGUAL (>=) | Input Filtro: ${filtroData} | Normalized: [${normalizedDate}] | Match: ${isDataMatch}`);
                
                return isDataMatch;
            });
        }
        
        function populateMedicoFilter(data) {
            
            const nomesValidos = data
                .map(item => item[K_MEDICO] ? String(item[K_MEDICO]).trim().toUpperCase() : null)
                .filter(nome => nome && nome !== ''); 

            const medicos = [...new Set(nomesValidos)].sort();

            const select = document.getElementById('filtroMedico');
            select.innerHTML = '<option value="todos">Todos os Médicos</option>'; 
            
            medicos.forEach(medico => {
                const option = document.createElement('option');
                option.value = medico;
                option.textContent = medico;
                select.appendChild(option);
            });
            
            select.disabled = false;
            document.getElementById('filtroData').disabled = false;
        }

        // --- FUNÇÃO generateKPIs MODIFICADA PARA NOVAS MÉTRICAS ---
        function generateKPIs(data) {
            const filtroMedico = document.getElementById('filtroMedico').value;
            
            // KPI 1: Total Geral de Atendimentos (Mantém o original)
            const totalAtendimentosOriginal = data.reduce((sum, row) => sum + (row[K_ATEND_TOTAL] || 0), 0);
            document.getElementById('totalAtendimentos').textContent = totalAtendimentosOriginal.toLocaleString('pt-BR');
            
            // KPI 2: Novos Atendimentos (Anteriormente: Total Geral/Filtrado)
            const novosAtendimentos = data.reduce((sum, row) => sum + (row[K_ATEND_NOVO] || 0), 0);
            document.getElementById('totalAtendimentosMedico').textContent = novosAtendimentos.toLocaleString('pt-BR');
            
            const tituloKPI = document.querySelector('#kpi-atendimento-medico h5');
            if (filtroMedico !== 'todos') {
                const primeiroNome = filtroMedico.split(' ')[0];
                tituloKPI.textContent = `Novos Atend. de ${primeiroNome}`;
            } else {
                tituloKPI.textContent = 'Novos Atendimentos';
            }
            
            // KPI 3: Total de Reavaliações (Anteriormente: Medicações EV)
            const totalReavaliacoes = data.reduce((sum, row) => sum + (row[K_REAVALIACOES] || 0), 0);
            document.getElementById('totalEV').textContent = totalReavaliacoes.toLocaleString('pt-BR');
            
            // KPI 4: Total Atend. + Reavaliações (Anteriormente: Ecocardiogramas)
            const totalGeralCompleto = data.reduce((sum, row) => sum + (row[K_TOTAL_GERAL] || 0), 0);
            document.getElementById('totalEcocardiogramas').textContent = totalGeralCompleto.toLocaleString('pt-BR');
        }

        function getProdutividadePorMedicoData(data) {
            const agrupado = data.reduce((acc, row) => {
                const medico = String(row[K_MEDICO]).trim();
                // Utilizando a coluna K_ATEND_TOTAL (Total de atendimento) para os gráficos, conforme original
                acc[medico] = (acc[medico] || 0) + (row[K_ATEND_TOTAL] || 0); 
                return acc;
            }, {});
            
            const sortedEntries = Object.entries(agrupado).sort(([, a], [, b]) => b - a);
            return {
                labels: sortedEntries.map(([medico]) => medico),
                data: sortedEntries.map(([, total]) => total)
            };
        }

        function getExamesPorMedicoData(data) {
            const exameCols = [K_ECHO, K_ELETRO, K_LAB, K_RX, K_TOMO, K_USG];
            const labels = ['Ecocardiograma', 'Eletrocardiograma', 'Laboratoriais', 'RX', 'Tomografias', 'USG'];
            const medicos = [...new Set(data.map(item => String(item[K_MEDICO]).trim()))].sort();
            
            const datasets = labels.map((label, index) => {
                const colName = exameCols[index];
                const backgroundColors = [colors.primario, colors.secundario, colors.amarelo, colors.vermelho, colors.roxo, colors.ciano];
                
                const dataValues = medicos.map(medico => 
                    data.filter(row => String(row[K_MEDICO]).trim() === medico)
                        .reduce((sum, row) => sum + (row[colName] || 0), 0)
                );
                
                return {
                    label: label,
                    data: dataValues,
                    backgroundColor: backgroundColors[index % backgroundColors.length],
                };
            });
            return {
                labels: medicos,
                datasets: datasets
            };
        }

        function getMedicacoesPorMedicoData(data) {
            const medCols = [K_MED_EV, K_MED_IM, K_MED_SUBCUT, K_MED_VO, K_MED_OFTAL, K_MED_INAL];
            const agrupado = data.reduce((acc, row) => {
                const medico = String(row[K_MEDICO]).trim();
                const totalMeds = medCols.reduce((sum, col) => sum + (row[col] || 0), 0);
                acc[medico] = (acc[medico] || 0) + totalMeds;
                return acc;
            }, {});
            const sortedEntries = Object.entries(agrupado).sort(([, a], [, b]) => b - a);
            return {
                labels: sortedEntries.map(([medico]) => medico),
                data: sortedEntries.map(([, total]) => total)
            };
        }
        
        function getAtendimentosDiaSemanaData(data) {
            const ordemDias = ['SEGUNDA-FEIRA', 'TERÇA-FEIRA', 'QUARTA-FEIRA', 'QUINTA-FEIRA', 'SEXTA-FEIRA', 'SÁBADO', 'DOMINGO'];
            const agrupado = data.reduce((acc, row) => {
                const dia = row[K_DIA_SEMANA] ? String(row[K_DIA_SEMANA]).toUpperCase().trim() : 'N/A';
                acc[dia] = (acc[dia] || 0) + (row[K_ATEND_TOTAL] || 0); // Usando K_ATEND_TOTAL
                return acc;
            }, {});
            const labels = ordemDias.filter(dia => agrupado[dia] !== undefined);
            const dataValues = labels.map(dia => agrupado[dia] || 0);
            return { labels, data: dataValues };
        }

        function getMedicacoesData(data) {
            const medCols = [K_MED_EV, K_MED_IM, K_MED_SUBCUT, K_MED_VO, K_MED_OFTAL, K_MED_INAL];
            const labels = ['EV', 'IM', 'Subcutânea', 'VO/Sublingual', 'Oftálmica', 'Inalação'];
            const dataValues = medCols.map(col => 
                data.reduce((sum, row) => sum + (row[col] || 0), 0)
            );
            return { labels, data: dataValues };
        }
        
        function createCharts(data) {
            // Destrói instâncias anteriores para evitar vazamento de memória e sobreposição
            if (examesPorMedicoChartInstance) examesPorMedicoChartInstance.destroy();
            if (medicacoesPorMedicoChartInstance) medicacoesPorMedicoChartInstance.destroy();
            if (produtividadePorMedicoChartInstance) produtividadePorMedicoChartInstance.destroy();
            if (atendimentosDiaSemanaChartInstance) atendimentosDiaSemanaChartInstance.destroy();
            if (medicacoesChartInstance) medicacoesChartInstance.destroy();

            // 1. Produtividade por Médico
            const produtividadeMedico = getProdutividadePorMedicoData(data);
            if (produtividadeMedico.data.length > 0) {
                 produtividadePorMedicoChartInstance = new Chart(document.getElementById('produtividadePorMedicoChart'), {
                    type: 'bar',
                    data: {
                        labels: produtividadeMedico.labels,
                        datasets: [{
                            label: 'Total de Atendimentos',
                            data: produtividadeMedico.data,
                            backgroundColor: colors.secundario,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, 
                        indexAxis: 'y', 
                        scales: { 
                            x: { beginAtZero: true },
                            y: {
                                ticks: {
                                    font: { size: 10 },
                                    callback: function(value, index, values) {
                                        const label = this.getLabelForValue(value);
                                        if (label && label.length > 20) { return label.split(' '); }
                                        return label;
                                    }
                                }
                            }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // 2. Atendimentos por Dia da Semana
            const atendimentosDiaSemana = getAtendimentosDiaSemanaData(data);
            if (atendimentosDiaSemana.data.length > 0) {
                atendimentosDiaSemanaChartInstance = new Chart(document.getElementById('atendimentosDiaSemanaChart'), {
                    type: 'line',
                    data: {
                        labels: atendimentosDiaSemana.labels,
                        datasets: [{
                            label: 'Total de Atendimentos',
                            data: atendimentosDiaSemana.data,
                            backgroundColor: 'rgba(0, 123, 255, 0.2)',
                            borderColor: colors.primario,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true } },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // 3. Exames Solicitados por Médico (Gráfico Empilhado)
            const examesPorMedicoData = getExamesPorMedicoData(data);
            if (examesPorMedicoData.labels.length > 0) {
                examesPorMedicoChartInstance = new Chart(document.getElementById('examesPorMedicoChart'), {
                    type: 'bar',
                    data: examesPorMedicoData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { 
                                stacked: true, 
                                title: { display: true, text: 'Médicos' },
                                ticks: { font: { size: 10 } }
                            },
                            y: { stacked: true, beginAtZero: true }
                        },
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            }
            
            // 4. Medicações Prescritas por Médico (Total)
            const medicacoesPorMedicoData = getMedicacoesPorMedicoData(data);
            if (medicacoesPorMedicoData.data.length > 0) {
                medicacoesPorMedicoChartInstance = new Chart(document.getElementById('medicacoesPorMedicoChart'), {
                    type: 'bar',
                    data: {
                        labels: medicacoesPorMedicoData.labels,
                        datasets: [{
                            label: 'Total de Medicações',
                            data: medicacoesPorMedicoData.data,
                            backgroundColor: colors.roxo,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { 
                            y: { beginAtZero: true },
                            x: { ticks: { font: { size: 10 } } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // 5. Medicações Prescritas (Total Geral)
            const medicacoes = getMedicacoesData(data);
            if (medicacoes.data.length > 0) {
                medicacoesChartInstance = new Chart(document.getElementById('medicacoesChart'), {
                    type: 'bar',
                    data: {
                        labels: medicacoes.labels,
                        datasets: [{
                            label: 'Total de Prescrições',
                            data: medicacoes.data,
                            backgroundColor: colors.amarelo,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y', 
                        scales: { x: { beginAtZero: true } },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        }

        // --- FUNÇÃO ADICIONAL PARA GERENCIAR O ALERTA DE FILTRO VAZIO ---
        function toggleFilterAlert(show) {
            const alertDiv = document.getElementById('filterAlert');
            if (show) {
                alertDiv.style.display = 'block';
                // Esconde o alerta automaticamente após 8 segundos
                setTimeout(() => {
                    alertDiv.style.display = 'none';
                }, 8000); 
            } else {
                alertDiv.style.display = 'none';
            }
        }
        
        // --- NOVA FUNÇÃO PARA LIMPAR FILTROS ---
        function clearFilters() {
            // Reseta o filtro do médico para "Todos"
            document.getElementById('filtroMedico').value = 'todos';
            // Limpa o campo de data
            document.getElementById('filtroData').value = '';
            
            // Chama a função principal de atualização
            updateDashboard();
            
            console.log("Filtros de Médico e Data limpos. Dashboard atualizado.");
        }


        // --- INICIALIZAÇÃO E EVENTOS ---

        async function initDashboard() {
            allData = await loadDataFromSQLite(); 

            if (allData.length > 0) {
                populateMedicoFilter(allData);
                updateDashboard();

                // NOVO: Adiciona os event listeners aos botões
                document.getElementById('applyFiltersBtn').onclick = updateDashboard;
                document.getElementById('clearFiltersBtn').onclick = clearFilters;
                
                // NOVO: Habilita os botões de filtro
                document.getElementById('applyFiltersBtn').disabled = false;
                document.getElementById('clearFiltersBtn').disabled = false;

                // NOTA: Os eventos onchange do filtroMedico e filtroData foram removidos para exigir o clique no botão "Aplicar Filtros".

            } else {
                // Desabilita filtros se não houver dados
                document.getElementById('filtroMedico').disabled = true;
                document.getElementById('filtroData').disabled = true;
                
                // Desabilita os botões em caso de erro/falta de dados
                document.getElementById('applyFiltersBtn').disabled = true;
                document.getElementById('clearFiltersBtn').disabled = true;
                
                console.log("Não há dados para exibir.");
            }
        }
        
        function updateDashboard() {
            const filteredData = filterData(allData);

            // NOVO: Verifica se há dados filtrados e gerencia o alerta
            if (filteredData.length === 0) {
                toggleFilterAlert(true);
                // Gera KPIs e Charts com dados vazios para zerar a interface
                generateKPIs([]); 
                createCharts([]);
            } else {
                toggleFilterAlert(false);
                generateKPIs(filteredData);
                createCharts(filteredData);
            }
        }

        // Chamada de inicialização
        initDashboard();

    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>