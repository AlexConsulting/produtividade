<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Produtividade (ASP.NET)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .cadastro-header { background-color: #007bff; color: white; padding: 20px 0; margin-bottom: 30px; }
        .form-container { 
            background-color: white; 
            padding: 30px; 
            border-radius: .5rem; 
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,.1); 
        }
        .section-title { margin-top: 20px; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 20px; }
    </style>
</head>
<body>

    <header class="cadastro-header">
        <div class="container">
            <h1 class="text-center">Formulário de Cadastro de Produtividade</h1>
            <p class="text-center"></p>
        </div>
    </header>

    <main class="container">
        <div id="statusMessage" class="alert text-center" role="alert" style="display:none;"></div>

        <div class="form-container">
            <form id="cadastroForm">
                
                <h4 class="section-title">Informações Básicas</h4>
                
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="Data_do_plantao" class="form-label">Data do plantao:</label>
                        <input type="date" class="form-control" name="Data do plantao:" required>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="Diurno_ou_noturno" class="form-label">Turno:</label>
                        <select class="form-select" name="Diurno ou noturno:" required>
                            <option value="">Selecione...</option>
                            <option value="DIURNO">DIURNO</option>
                            <option value="INTERMEDIARIO">INTERMEDIÁRIO</option>
                            <option value="NOTURNO">NOTURNO</option>
                        </select>
                    </div>
                    
                    <div class="col-md-4">
                        <label for="Dia_da_sema" class="form-label">Dia da sema:</label>
                        <input type="text" class="form-control" name="Dia da sema:" placeholder="Ex: SEGUNDA-FEIRA" required>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <label for="Nome_do_medico" class="form-label">Nome completo do medico:</label>
                        <input type="text" class="form-control" name="Nome do medico (nome completo,  maiusculo) :" placeholder="NOME COMPLETO, MAIÚSCULO" required>
                    </div>
                    <div class="col-md-6">
                        <label for="Consultorio" class="form-label">Consultorio:</label>
                        <input type="text" class="form-control" name="Consultorio" placeholder="Ex: C1">
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label for="Cliente" class="form-label">Cliente:</label>
                        <input type="text" class="form-control" name="Cliente" required>
                    </div>
                    <div class="col-md-6">
                        <label for="Unidade" class="form-label">Unidade:</label>
                        <input type="text" class="form-control" name="Unidade" required>
                    </div>
                </div>


                <h4 class="section-title">Atendimentos e Totais</h4>

                <div class="row mb-4">
                    <div class="col-md-4">
                        <label for="Numero_de_Novos_atendimentos" class="form-label">Número de Novos Atendimentos:</label>
                        <input type="number" class="form-control" id="Novos_Atendimentos" name="Numero de Novos atendimentos:" value="0" min="0" required>
                    </div>
                    <div class="col-md-4">
                        <label for="Numero_Reavalicoes" class="form-label">Número Reavalições</label>
                        <input type="number" class="form-control" id="Numero_Reavalicoes" name="Numero Reavalicões" value="0" min="0" required>
                    </div>
                    <div class="col-md-4">
                        <label for="Total_atendimentos_completo" class="form-label">Total Geral - Novos Atendimentos e Reavalições:</label>
                        <input type="number" class="form-control" id="Total_atendimentos_completo" name="Total de atendimento novos atendimentos e reavalicões:" value="0" min="0" required readonly>
                        <small class="text-muted">Calculado (Novos + Reavaliações)</small>
                    </div>
                </div>

                <h4 class="section-title">Classificação de Risco (Fichas):</h4>
                
                <div class="row mb-4">
                    <div class="col-md-2"><label for="Ficha_verde" class="form-label">Verdes</label><input type="number" class="form-control" name="Numero de fichas verdes" value="0" min="0"></div>
                    <div class="col-md-2"><label for="Ficha_amarela" class="form-label">Amarelas</label><input type="number" class="form-control" name="Numero de fichas amarelas" value="0" min="0"></div>
                    <div class="col-md-2"><label for="Ficha_laranja" class="form-label">Laranjas</label><input type="number" class="form-control" name="Numero de fichas laranja" value="0" min="0"></div>
                    <div class="col-md-2"><label for="Ficha_azul" class="form-label">Azuis</label><input type="number" class="form-control" name="Numero de fichas azul" value="0" min="0"></div>
                    <div class="col-md-2"><label for="Ficha_branca" class="form-label">Brancas</label><input type="number" class="form-control" name="Numero de fichas brancas" value="0" min="0"></div>
                    <div class="col-md-2"><label for="Ficha_vermelha" class="form-label">Vermelhas</label><input type="number" class="form-control" name="Numero de fichas Vermelhas" value="0" min="0"></div>
                </div>

                <h4 class="section-title">Exames</h4>
                
                <div class="row mb-4">
                    <div class="col-md-2"><label for="ecocardiograma" class="form-label">Ecocardiograma</label><input type="number" class="form-control" name="Numero de ecocardiograma" value="0" min="0"></div>
                    <div class="col-md-2"><label for="eletrocardiograma" class="form-label">Eletrocardiograma</label><input type="number" class="form-control" name="Numero de eletrocardiograma" value="0" min="0"></div>
                    <div class="col-md-2"><label for="laboratoriais" class="form-label">Laboratoriais</label><input type="number" class="form-control" name="Numero de laboratoriais" value="0" min="0"></div>
                    <div class="col-md-2"><label for="RX" class="form-label">RX</label><input type="number" class="form-control" name="Numero de RX" value="0" min="0"></div>
                    <div class="col-md-2"><label for="Tomografias" class="form-label">Tomografias</label><input type="number" class="form-control" name="Tomografias" value="0" min="0"></div>
                    <div class="col-md-2"><label for="USG" class="form-label">USG</label><input type="number" class="form-control" name="USG" value="0" min="0"></div>
                </div>

                <h4 class="section-title">Medicações Prescritas:</h4>

                <div class="row mb-5">
                    <div class="col-md-2"><label for="Med_EV" class="form-label">EV</label><input type="number" class="form-control" name="Medicacao prescritas EV" value="0" min="0"></div>
                    <div class="col-md-2"><label for="Med_IM" class="form-label">IM</label><input type="number" class="form-control" name="Medicacao prescritas IM" value="0" min="0"></div>
                    <div class="col-md-2"><label for="Med_Subcultanea" class="form-label">Subcutanea</label><input type="number" class="form-control" name="Medicacao Subcultanea" value="0" min="0"></div>
                    <div class="col-md-2"><label for="Med_VO" class="form-label">VO ou Subligual</label><input type="number" class="form-control" name="Medicacao VO ou Subligual" value="0" min="0"></div>
                    <div class="col-md-2"><label for="Med_OFTALMICA" class="form-label">Oftalmica</label><input type="number" class="form-control" name="Medicacao OFTALMICA" value="0" min="0"></div>
                    <div class="col-md-2"><label for="ILAcaO" class="form-label">Inalação</label><input type="number" class="form-control" name="ILAcaO" value="0" min="0"></div>
                </div>

                <button type="submit" class="btn btn-primary btn-lg w-100" id="saveButton">
                    Salvar Registro no Banco de Dados
                </button>

            </form>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('cadastroForm');
            const statusMessage = document.getElementById('statusMessage');
            const novosInput = document.getElementById('Novos_Atendimentos');
            const reavalInput = document.getElementById('Numero_Reavalicoes');
            const totalInput = document.getElementById('Total_atendimentos_completo');

            // Lógica para calcular o total dinamicamente
            const updateSum = () => {
                const novos = Number(novosInput.value) || 0;
                const reaval = Number(reavalInput.value) || 0;
                totalInput.value = novos + reaval;
            };

            novosInput.addEventListener('input', updateSum);
            reavalInput.addEventListener('input', updateSum);
            updateSum(); // Inicializa o total

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const btnSalvar = document.getElementById('saveButton');
                btnSalvar.disabled = true;

                const formData = new FormData(form);
                const data = {};
                
                // Popula o objeto de dados com os valores do formulário
                formData.forEach((value, key) => {
                    // Trata campos numéricos
                    if (document.querySelector(`[name="${key}"]`).type === 'number') {
                        data[key] = Number(value) || 0;
                    } else {
                        data[key] = value;
                    }
                });

                // Insere o campo automático 'Carimbo de data/hora'
                data["Carimbo de data/hora"] = new Date().toISOString().replace('T', ' ').substring(0, 19);
                
                // O cálculo do Total de atendimento já foi feito na linha 144, mas garantimos que o nome da chave está correto
                // Já está no FormData, mas apenas para garantir que o valor calculado (readonly) seja enviado
                data["Total de atendimento novos atendimentos e reavalicões:"] = Number(totalInput.value);

                statusMessage.style.display = 'block';
                statusMessage.className = 'alert alert-info';
                statusMessage.textContent = 'Enviando dados para o servidor...';

                try {
                    // Endpoint no servidor ASP.NET para salvar os dados
                    const response = await fetch('SaveData.aspx', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    const result = await response.text();

                    if (response.ok) {
                        statusMessage.className = 'alert alert-success';
                        statusMessage.textContent = 'Sucesso! Dados salvos permanentemente no DB.';
                        form.reset();
                        updateSum(); // Limpa o total após o reset
                    } else {
                        statusMessage.className = 'alert alert-danger';
                        // Exibe a mensagem de erro detalhada do servidor
                        statusMessage.textContent = `Erro ao salvar: ${result || 'Erro desconhecido.'}`; 
                    }

                } catch (error) {
                    statusMessage.className = 'alert alert-danger';
                    statusMessage.textContent = `Erro de conexão com o servidor: ${error.message}`;
                } finally {
                    btnSalvar.disabled = false;
                }
            });
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>